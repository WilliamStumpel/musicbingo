---
phase: 02-card-printing-system
plan: 01-FIX2
type: fix
wave: 1
depends_on: []
files_modified:
  - musicbingo_cards/src/musicbingo_cards/pdf_generator.py
autonomous: true
---

<objective>
Fix 2 UAT issues from plan 02-01 (re-verification round 2).

Source: 02-01-ISSUES.md
Priority: 0 critical, 2 major, 0 minor

**Issues:**
- UAT-002: Logo layout issues (size, centering, QR overflow, 4-up card-level branding)
- UAT-003: DJ contact layout issues (centering, QR overflow, 4-up card-level branding)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/02-card-printing-system/02-01-ISSUES.md

**Source file to fix:**
@musicbingo_cards/src/musicbingo_cards/pdf_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix single-card layout branding (centered, no QR overflow)</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py</files>
  <action>
**Problem:** In single-card layout:
1. Logo too small (0.75 inch max height)
2. Logo/DJ contact in left/right table, not centered
3. Adding branding header pushes QR code off the page (no space management)

**Solution:** Redesign `_create_branding_header()` and adjust `_create_card_elements()`:

1. **Center the logo** (not left-aligned):
   - Remove the two-column table layout
   - Create centered logo using TA_CENTER alignment
   - Increase max logo height to 1.0 inch for better visibility

2. **Center the DJ contact** (below logo, not right-aligned):
   - Move DJ contact below logo as centered text
   - Style with TA_CENTER alignment

3. **Manage vertical space to prevent QR overflow:**
   - The page is 11 inches (792 points) with 0.5 inch margins = 10 inch usable
   - Current elements: header (~1 inch) + title (~0.4 inch) + grid (~7 inch at 1.4" cells) + QR (~1.5 inch + card ID) = ~10 inch
   - With branding, this overflows
   - **Fix:** Reduce grid cell size from 1.4 inch max to 1.2 inch when branding is present
   - Calculate: 5 * 1.2 = 6 inch grid + 1 inch header + 0.4 title + 0.3 spacer + 1.5 QR + 0.2 card ID = ~9.4 inch (fits)

**Implementation changes to `_create_branding_header()`:**
```python
def _create_branding_header(self) -> List:
    elements = []
    if not self.venue_logo_path and not self.dj_contact:
        return elements

    # Centered logo
    if self.venue_logo_path and self.venue_logo_path.exists():
        try:
            # Load image, scale to max 1.0 inch height, center it
            # Use TA_CENTER for Image placement
            ...
        except Exception:
            pass

    # Centered DJ contact below logo
    if self.dj_contact:
        dj_style = ParagraphStyle(
            'DJContactCentered',
            parent=self.styles['Normal'],
            alignment=TA_CENTER,
            fontSize=11,
        )
        elements.append(Paragraph(self.dj_contact, dj_style))
        elements.append(Spacer(1, 0.15 * inch))

    return elements
```

**Implementation changes to `_create_card_elements()`:**
- Add logic to reduce cell_size when branding is present:
```python
# Reduce grid cell size when branding is present to prevent overflow
has_branding = self.venue_logo_path or self.dj_contact
cell_size = min(page_width / 5, 1.2 * inch if has_branding else 1.4 * inch)
```
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
musicbingo generate games/test-playlist.json -n 2 --venue-logo Attach0.jpeg --dj-contact "DJ Awesome | @djawesome" -o test-single.pdf
```
Open PDF and verify:
- Logo appears centered and appropriately sized (~1 inch tall)
- DJ contact appears centered below logo
- Grid and QR code fit on page without overflow
- All elements visible and properly spaced
  </verify>
  <done>
- Logo centered on card (not left-aligned)
- Logo appropriately sized (~1 inch height)
- DJ contact centered below logo
- QR code and all elements fit on page without overflow
- Proper vertical spacing throughout
  </done>
</task>

<task type="auto">
  <name>Task 2: Add card-level branding to 4-up layout mini cards</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py</files>
  <action>
**Problem:** In 4-up layout:
- Branding only appears at page level (header/footer)
- User expects each of the 4 mini cards to have its own branding
- Current `_draw_mini_card()` has no branding

**Solution:** Add compact branding to each mini card in `_draw_mini_card()`:

1. **Remove page-level branding for 4-up:**
   - In `_generate_4up_pdf()`, don't call `_draw_page_header()` or `_draw_page_footer()`
   - Set header_height and footer_height to 0

2. **Add card-level branding to `_draw_mini_card()`:**
   - Add mini logo at top of each card (above title)
   - Add DJ contact at bottom of each card (below QR code)
   - Adjust vertical layout to accommodate branding

**Layout adjustment for mini card with branding (4.5 inch = 324 points height):**
- Logo: 0.3 inch (if present)
- Title: 0.25 inch
- Gap: 0.05 inch
- Grid: 5 * 0.55 inch = 2.75 inch (reduce from 0.6 inch cells)
- Gap: 0.1 inch
- QR: 0.55 inch (reduce from 0.6 inch)
- Card ID: 0.15 inch
- DJ contact: 0.2 inch (if present)
- Total: ~4.35 inch (fits in 4.5 inch)

**Implementation in `_draw_mini_card()`:**
```python
def _draw_mini_card(...):
    # Check if branding present
    has_branding = self.venue_logo_path or self.dj_contact

    # Adjust sizes for branding
    if has_branding:
        cell_size = 0.55 * inch  # Reduced from 0.6
        qr_size = 0.55 * inch    # Reduced from 0.6
        logo_height = 0.3 * inch
    else:
        cell_size = 0.6 * inch
        qr_size = 0.6 * inch
        logo_height = 0

    # Draw mini logo at top (centered)
    if self.venue_logo_path and self.venue_logo_path.exists():
        # Load, scale to 0.3 inch height, draw centered
        ...

    # Adjust title_y to account for logo
    title_y = y + height - (0.3 * inch if has_branding else 0.1 * inch) - logo_height

    # ... existing grid and QR drawing ...

    # Draw DJ contact at bottom (centered, below card ID)
    if self.dj_contact:
        canvas.setFont("Helvetica", 5)
        dj_width = canvas.stringWidth(self.dj_contact, "Helvetica", 5)
        canvas.drawString(card_center_x - dj_width / 2, qr_y - 18, self.dj_contact)
```
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
musicbingo generate games/test-playlist.json -n 8 --layout 4up --venue-logo Attach0.jpeg --dj-contact "DJ Awesome | @djawesome" -o test-4up.pdf
```
Open PDF and verify:
- Each of the 4 mini cards has its own logo at top
- Each mini card has DJ contact at bottom
- Grid and QR code fit within each mini card
- No page-level header/footer (branding is per-card)
  </verify>
  <done>
- Each mini card has its own centered logo at top
- Each mini card has DJ contact at bottom
- Grid cells and QR code sized appropriately
- No page-level branding (all branding at card level)
- All 4 cards fit properly on page
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests and verify no regressions</name>
  <files>musicbingo_cards/tests/</files>
  <action>
Run the test suite to ensure fixes don't break existing functionality:

```bash
cd /Users/bill/dev/musicbingo && pytest musicbingo_cards/tests/ -v
```

If any tests fail, fix them.

Also manually verify:
1. Single layout without branding still works
2. Single layout with branding: logo centered, DJ centered, QR fits
3. 4-up layout without branding still works
4. 4-up layout with branding: each card has own logo and DJ contact
5. QR codes are still scannable
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && pytest musicbingo_cards/tests/ -v
```
All tests pass.
  </verify>
  <done>
- All existing tests pass
- No regressions in card generation
- Both layouts work correctly with and without branding
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-002 fixed: Logo properly sized, centered, no overflow
- [ ] UAT-003 fixed: DJ contact centered, no overflow
- [ ] 4-up branding at card level (not page level)
- [ ] pytest passes
- [ ] Single layout cards fit on page
- [ ] 4-up mini cards fit with branding
- [ ] QR codes still scannable
</verification>

<success_criteria>
- All UAT issues from 02-01-ISSUES.md addressed
- Tests pass
- Ready for re-verification with /gsd:verify-work 02 01
</success_criteria>

<output>
After completion, update `.planning/phases/02-card-printing-system/02-01-ISSUES.md` to move resolved issues to "Resolved Issues" section.
</output>
