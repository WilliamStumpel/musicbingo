---
phase: 02-card-printing-system
plan: 01-FIX
type: fix
wave: 1
depends_on: []
files_modified:
  - musicbingo_cards/src/musicbingo_cards/pdf_generator.py
autonomous: true
---

<objective>
Fix 3 UAT issues from plan 02-01.

Source: 02-01-ISSUES.md
Priority: 0 critical, 3 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/02-card-printing-system/02-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/02-card-printing-system/02-01-PLAN.md

**Source file to fix:**
@musicbingo_cards/src/musicbingo_cards/pdf_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Implement word wrapping and dynamic font sizing for 4-up cells</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py</files>
  <action>
**Problem:** Text is hard-truncated at 12-14 characters for titles and 10-12 for artists:
```python
title = song.title[:12] + "..." if len(song.title) > 14 else song.title
artist = song.artist[:10] + "..." if len(song.artist) > 12 else song.artist
```

This makes long song titles unreadable (e.g., "Don't Stop B..." instead of full title).

**Solution:** Replace hard truncation with smart text fitting:

1. **Create helper method `_fit_text_in_cell()`** that:
   - Takes text, max_width, max_height, base_font_size, min_font_size
   - First tries to word-wrap at base font size
   - If still too tall, progressively shrink font until it fits
   - Returns (lines_list, final_font_size)

2. **Word wrapping approach:**
   - Use `canvas.stringWidth()` to measure text width
   - Split on spaces, build lines that fit within cell width
   - For very long words (no spaces), use character-level wrapping

3. **Dynamic font sizing:**
   - Start at base font (6pt for title, 5pt for artist)
   - If wrapped text exceeds vertical space, try smaller font (min 4pt)
   - Calculate available height: cell has ~40pt total, split between title (top half) and artist (bottom half)

4. **Implementation in `_draw_mini_card()`:**
   - Remove the hard truncation logic
   - Call `_fit_text_in_cell()` for title and artist separately
   - Draw each line centered in the cell

**Pseudocode for _fit_text_in_cell:**
```python
def _fit_text_in_cell(self, canvas, text, max_width, max_height,
                       font_name, base_size, min_size=4):
    for font_size in range(base_size, min_size - 1, -1):
        lines = self._wrap_text(canvas, text, max_width, font_name, font_size)
        line_height = font_size * 1.2
        total_height = len(lines) * line_height
        if total_height <= max_height:
            return lines, font_size
    # If still doesn't fit at min size, truncate last line with "..."
    return lines[:max_lines], min_size

def _wrap_text(self, canvas, text, max_width, font_name, font_size):
    words = text.split()
    lines = []
    current_line = ""
    for word in words:
        test_line = f"{current_line} {word}".strip()
        if canvas.stringWidth(test_line, font_name, font_size) <= max_width:
            current_line = test_line
        else:
            if current_line:
                lines.append(current_line)
            current_line = word
    if current_line:
        lines.append(current_line)
    return lines
```

5. **Cell layout:**
   - Cell size: 0.6 inch (~43pt)
   - Usable width: ~38pt (with small padding)
   - Title area: top 20pt of cell
   - Artist area: bottom 18pt of cell
   - Max 2 lines each for title and artist
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
musicbingo generate games/test-playlist.json -n 8 --layout 4up -o /tmp/test-wrap-fix.pdf
```
Open PDF and verify:
- Long song titles wrap to multiple lines or shrink to fit
- No "..." truncation unless absolutely necessary
- Text is readable within cells
  </verify>
  <done>
- Long titles word-wrap within cells (e.g., "Don't Stop Believin'" shows fully)
- Font dynamically shrinks for very long text
- Text remains readable (minimum 4pt font)
- No hard truncation at arbitrary character limits
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 & UAT-003 - Ensure branding renders for all layouts</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py</files>
  <action>
**Problem analysis:**
1. The `_draw_page_header` and `_draw_page_footer` methods exist but are only called in `_generate_4up_pdf()`, not in the single-card `generate_pdf()` method.
2. JPEG images may fail silently in ReportLab - need better error handling and format support.

**Fixes required:**

1. **Fix logo loading for JPEG:**
In `_draw_page_header()`, the `canvas.drawImage()` call may fail for JPEG. Convert the image to a format ReportLab handles better:
- Use PIL to open image regardless of format
- Convert to RGB mode if needed (handles RGBA PNGs too)
- Save to BytesIO buffer as PNG
- Use ImageReader from reportlab.lib.utils to draw

Replace lines 346-372 with:
```python
if self.venue_logo_path and self.venue_logo_path.exists():
    try:
        from PIL import Image as PILImage
        from reportlab.lib.utils import ImageReader
        import io

        # Load and convert image
        with PILImage.open(self.venue_logo_path) as img:
            # Convert to RGB if needed (handles RGBA, palette, etc.)
            if img.mode != 'RGB':
                img = img.convert('RGB')

            img_width, img_height = img.size
            aspect_ratio = img_width / img_height

            # Scale to max height while maintaining aspect ratio
            logo_height = max_logo_height
            logo_width = logo_height * aspect_ratio

            # Cap width at 1.5 inches
            if logo_width > 1.5 * inch:
                logo_width = 1.5 * inch
                logo_height = logo_width / aspect_ratio

            # Save to buffer as PNG for reliable rendering
            img_buffer = io.BytesIO()
            img.save(img_buffer, format='PNG')
            img_buffer.seek(0)

        canvas.drawImage(
            ImageReader(img_buffer),
            self.margin,
            header_y,
            width=logo_width,
            height=logo_height,
        )
    except Exception as e:
        # Log error but continue without logo
        import sys
        print(f"Warning: Could not load logo: {e}", file=sys.stderr)
```

2. **Add branding to single-card layout:**
The single-card layout uses SimpleDocTemplate with story/flowables, which doesn't support canvas drawing directly. Two options:
- Option A: Add header/footer as flowable elements (Image + Paragraph)
- Option B: Use canvas callbacks for header/footer

Use Option A - add flowables for branding. In `_create_card_elements()`:
- If venue_logo_path exists: Add logo Image as first element
- If dj_contact exists: Add Paragraph with DJ contact
- Add these BEFORE the card title
- Also add footer after QR code section

Add helper method `_create_branding_elements()` that returns header flowables.
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \

# Create test JPEG logo
python -c "
from PIL import Image as PILImage
img = PILImage.new('RGB', (200, 100), color='red')
img.save('/tmp/test_logo.jpg', 'JPEG')
print('Test JPEG logo created')
"

# Test with JPEG logo - 4-up layout
musicbingo generate games/test-playlist.json -n 4 --layout 4up --venue-logo /tmp/test_logo.jpg --dj-contact "DJ Test | @djtest" -o /tmp/test-branding-4up.pdf

# Test with JPEG logo - single layout
musicbingo generate games/test-playlist.json -n 2 --layout single --venue-logo /tmp/test_logo.jpg --dj-contact "DJ Test | @djtest" -o /tmp/test-branding-single.pdf
```

Open both PDFs and verify:
- Logo appears (red rectangle)
- DJ contact text appears
- Both layouts show branding
  </verify>
  <done>
- JPEG logos render correctly (converted to PNG internally)
- PNG logos still work
- DJ contact appears on cards
- Both single and 4-up layouts show branding
- Error handling prevents silent failures
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests and verify no regressions</name>
  <files>musicbingo_cards/tests/</files>
  <action>
Run the test suite to ensure fixes don't break existing functionality:

```bash
cd /Users/bill/dev/musicbingo && pytest musicbingo_cards/tests/ -v
```

If any tests fail, fix them.

Also manually verify:
1. Basic card generation still works (no branding)
2. 4-up layout with branding works
3. Single layout with branding works
4. QR codes are still scannable
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && pytest musicbingo_cards/tests/ -v
```
All tests pass.
  </verify>
  <done>
- All existing tests pass
- No regressions in card generation
- Both layouts work correctly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 UAT issues fixed
- [ ] pytest passes
- [ ] 4-up text is readable
- [ ] JPEG logos work
- [ ] DJ contact appears on both layouts
- [ ] QR codes still scannable
</verification>

<success_criteria>
- All UAT issues from 02-01-ISSUES.md addressed
- Tests pass
- Ready for re-verification with /gsd:verify-work 02 01
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-printing-system/02-01-FIX-SUMMARY.md`
</output>
