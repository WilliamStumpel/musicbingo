---
phase: 02-card-printing-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - musicbingo_cards/src/musicbingo_cards/pdf_generator.py
  - musicbingo_cards/src/musicbingo_cards/cli.py
autonomous: true
---

<objective>
Implement professional card printing with 4-up layout, custom branding, and flexible card counts.

Purpose: Enable DJs to print professional bingo cards for venues with efficient paper usage (4 cards per page) and customizable branding.
Output: Enhanced PDF generator producing print-ready 4-up cards with venue logo and DJ contact info.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md

@musicbingo_cards/src/musicbingo_cards/pdf_generator.py
@musicbingo_cards/src/musicbingo_cards/cli.py
@musicbingo_cards/src/musicbingo_cards/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 4-up card layout for 8.5x11 pages</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py</files>
  <action>
Create a new method `generate_4up_pdf()` that arranges 4 cards in a 2x2 grid per page.

**Layout math for 8.5x11 letter (612x792 points):**
- Usable area with 0.5" margins: 7.5" x 10" (540x720 points)
- Card size: 3.5" x 4.5" (252x324 points) with 0.25" gutters between
- Grid: 2 columns x 2 rows per page
- Cell sizes: shrink to ~0.65" (47pt) per cell to fit
- QR code: shrink to ~0.8" (58pt)
- Font: reduce to 7pt for cell text

**Implementation approach:**
1. Create `_create_mini_card_table()` method that returns a Table with the 4-card grid
2. Each "cell" of the outer table contains one complete card (grid + QR + card number)
3. Use nested Tables: outer 2x2 table, each cell contains card content
4. Calculate pages needed: `ceil(num_cards / 4)`

**Key constraint:** Keep original `generate_pdf()` method for backwards compatibility. Add `layout` parameter with options "single" (default, current behavior) or "4up" (new).

**Sizing calculations:**
- Outer table: 2 cols x 2 rows, colWidths=[3.5*inch, 3.5*inch], rowHeights=[4.5*inch, 4.5*inch]
- Inner card grid: 5x5, cell_size = 0.6*inch (43pt)
- Card title: 10pt font
- Cell text: 7pt font, leading 8pt
- QR code: 0.75*inch (54pt)
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
python -c "
from musicbingo_cards.pdf_generator import PDFCardGenerator
from musicbingo_cards.models import BingoCard, CardGrid, Song
from uuid import uuid4

# Create test cards
cards = []
for i in range(8):  # 8 cards = 2 pages
    card = BingoCard(card_id=uuid4(), game_id=uuid4())
    for row in range(5):
        for col in range(5):
            if row == 2 and col == 2:
                continue
            card.add_song(row, col, Song(title=f'Song {row*5+col}', artist=f'Artist {i}'))
    cards.append(card)

gen = PDFCardGenerator()
gen.generate_pdf(cards, '/tmp/test_4up.pdf', layout='4up')
print('4-up PDF generated successfully')
"
```
Open `/tmp/test_4up.pdf` and verify:
- 2 pages with 4 cards each
- Cards are readable (text not clipped)
- QR codes are scannable size
  </verify>
  <done>
- `generate_pdf()` accepts `layout="4up"` parameter
- 4 cards fit on each 8.5x11 page in 2x2 grid
- Card content is readable (song titles, artists visible)
- QR codes are large enough to scan (~0.75")
  </done>
</task>

<task type="auto">
  <name>Task 2: Add custom branding (venue logo and DJ contact)</name>
  <files>musicbingo_cards/src/musicbingo_cards/pdf_generator.py, musicbingo_cards/src/musicbingo_cards/cli.py</files>
  <action>
**PDF Generator changes:**

1. Add optional parameters to `__init__()`:
   - `venue_logo_path: Optional[Path]` - path to logo image (PNG/JPG)
   - `dj_contact: Optional[str]` - DJ contact text (e.g., "DJ Bill | @djbill | djbill.com")

2. Create `_add_page_header()` method:
   - If venue_logo_path provided: render logo at top-left (max 1" tall, proportional width)
   - If dj_contact provided: render text at top-right
   - Return vertical space consumed (for content offset)

3. Create `_add_page_footer()` method:
   - Centered text: "Music Bingo by [dj_contact]" or just "Music Bingo"
   - Small font (8pt)

4. Integrate header/footer into both `generate_pdf()` and `generate_4up_pdf()`:
   - Header appears once per page (not per card)
   - Adjust content area to account for header/footer space

**CLI changes:**

Update the `generate` command to pass branding options to PDFCardGenerator:
- Remove the "Coming soon" warnings for `--venue-logo` and `--dj-contact`
- Pass values to PDFCardGenerator constructor
- Add validation: venue-logo file must exist and be PNG/JPG

**Image handling:**
- Use ReportLab's Image class
- Detect image dimensions with Pillow to maintain aspect ratio
- Max logo height: 0.75" for 4-up layout, 1" for single layout
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
# Create a test logo (simple colored square)
python -c "
from PIL import Image as PILImage
img = PILImage.new('RGB', (200, 100), color='blue')
img.save('/tmp/test_logo.png')
print('Test logo created')
"

# Generate PDF with branding
python -c "
from musicbingo_cards.pdf_generator import PDFCardGenerator
from musicbingo_cards.models import BingoCard, CardGrid, Song
from uuid import uuid4
from pathlib import Path

cards = []
for i in range(4):
    card = BingoCard(card_id=uuid4(), game_id=uuid4())
    for row in range(5):
        for col in range(5):
            if row == 2 and col == 2:
                continue
            card.add_song(row, col, Song(title=f'Song {row*5+col}', artist=f'Artist {i}'))
    cards.append(card)

gen = PDFCardGenerator(venue_logo_path=Path('/tmp/test_logo.png'), dj_contact='DJ Bill | @djbill')
gen.generate_pdf(cards, '/tmp/test_branded.pdf', layout='4up')
print('Branded 4-up PDF generated')
"
```
Open `/tmp/test_branded.pdf` and verify:
- Logo appears at top-left of page
- DJ contact appears at top-right
- Cards are not overlapping with header
  </verify>
  <done>
- `PDFCardGenerator` accepts `venue_logo_path` and `dj_contact` parameters
- Logo renders at correct size with aspect ratio preserved
- DJ contact text renders at top-right
- CLI `--venue-logo` and `--dj-contact` flags work (no "coming soon" message)
  </done>
</task>

<task type="auto">
  <name>Task 3: Support flexible card counts (remove 200 limit)</name>
  <files>musicbingo_cards/src/musicbingo_cards/cli.py</files>
  <action>
**CLI changes:**

1. Remove the 200 card limit check in `generate` command:
   - Change validation from `50-200` to `1-1000` (reasonable upper bound for memory)
   - Update help text to reflect new range

2. Add progress feedback for large batches:
   - Use `click.progressbar()` for card generation loop if num_cards > 100
   - Show progress during PDF generation: "Rendering page X of Y..."

3. Add `--layout` option to CLI:
   - Choices: "single" (1 card/page, default for backwards compat) or "4up" (4 cards/page)
   - Help text explains paper savings

**Memory consideration:**
- For 500+ cards, consider generating PDF in batches and merging
- For now, ReportLab handles this reasonably well up to ~1000 cards
- Add note in help text: "For very large batches (500+), consider generating in multiple runs"
  </action>
  <verify>
```bash
cd /Users/bill/dev/musicbingo && \
# Test that 250 cards works (above old 200 limit)
/Users/bill/Library/Python/3.9/bin/musicbingo generate games/demo_2020s/demo_2020s.json -n 250 --layout 4up -o /tmp/test_250_cards.pdf

# Verify output
ls -lh /tmp/test_250_cards.pdf
# Should show ~63 pages (250/4 = 62.5, rounded up)
```
  </verify>
  <done>
- CLI accepts card counts from 1-1000
- `--layout` option with "single" and "4up" choices works
- 250+ cards generates without error
- Progress shown for batches > 100 cards
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest musicbingo_cards/tests/` passes (no regressions)
- [ ] `python -m musicbingo_cards.cli generate --help` shows new options
- [ ] 4-up layout produces readable cards with scannable QR codes
- [ ] Branding (logo + contact) renders correctly
- [ ] 250 cards generates successfully with 4-up layout
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- PDF generator supports both single and 4-up layouts
- CLI flags `--venue-logo`, `--dj-contact`, and `--layout` fully functional
- Card counts above 200 work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-printing-system/02-01-SUMMARY.md`
</output>
