---
phase: 04-host-view
plan: 04-02-FIX
type: fix
wave: 1
depends_on: ["04-02"]
files_modified:
  - musicbingo_api/src/musicbingo_api/main.py
  - musicbingo_api/src/musicbingo_api/game_service.py
  - musicbingo_host/src/hooks/useGameState.js
  - musicbingo_host/src/components/SongChecklist.jsx
  - musicbingo_host/src/components/SongChecklist.css
autonomous: true
---

<objective>
Fix 1 UAT issue from plan 04-02.

Source: 04-02-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/04-host-view/04-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/04-host-view/04-02-PLAN.md

**Current implementation:**
@musicbingo_host/src/hooks/useGameState.js
@musicbingo_host/src/components/SongChecklist.jsx
@musicbingo_api/src/musicbingo_api/main.py
@musicbingo_api/src/musicbingo_api/game_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unmark-song endpoint to API</name>
  <files>musicbingo_api/src/musicbingo_api/main.py, musicbingo_api/src/musicbingo_api/game_service.py</files>
  <action>
Add unmark_song method to GameService:
```python
def unmark_song(self, game_id: UUID, song_id: str) -> GameState:
    """Remove a song from played_songs list.

    Used when DJ accidentally marks wrong song.
    """
    game = self.get_game_or_raise(game_id)
    if song_id in game.played_songs:
        game.played_songs.remove(song_id)
        game.updated_at = datetime.now()
    return game
```

Add endpoint to main.py:
```python
@app.delete(
    "/api/game/{game_id}/song/{song_id}",
    response_model=GameStateResponse,
    responses={404: {"model": ErrorResponse}},
)
async def unmark_song(game_id: UUID, song_id: str):
    """Remove a song from played songs list.

    Used to undo an accidentally marked song.
    """
    try:
        service = get_game_service()
        game = service.unmark_song(game_id, song_id)

        return GameStateResponse(
            game_id=game.game_id,
            status=game.status,
            playlist_size=len(game.playlist),
            played_songs=game.played_songs,
            played_count=len(game.played_songs),
            current_pattern=game.current_pattern,
            card_count=len(game.cards),
            created_at=game.created_at,
            updated_at=game.updated_at,
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
```
  </action>
  <verify>curl -X DELETE http://localhost:8000/api/game/{game_id}/song/{song_id} returns GameStateResponse without that song_id in played_songs</verify>
  <done>DELETE /api/game/{id}/song/{song_id} endpoint removes song from played_songs</done>
</task>

<task type="auto">
  <name>Task 2: Add unmarkSong action to useGameState hook</name>
  <files>musicbingo_host/src/services/gameApi.js, musicbingo_host/src/hooks/useGameState.js</files>
  <action>
Add to gameApi.js:
```javascript
export async function unmarkSong(gameId, songId) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/song/${songId}`, {
    method: 'DELETE',
  });
  if (!response.ok) throw new Error('Failed to unmark song');
  return response.json();
}
```

Add to useGameState.js:
- unmarkSong action that:
  1. Optimistically removes song from playedSongs Set
  2. Removes song from playedOrder array
  3. Clears nowPlaying if it was the unmarked song
  4. Calls gameApi.unmarkSong(gameId, songId)
  5. Rolls back on error
- Export unmarkSong in hook return

The toggle behavior should be:
- If song NOT played: mark as played (existing behavior)
- If song IS played: unmark it (new behavior)

Modify existing toggleSong or create new logic in onSongClick handler.
  </action>
  <verify>Hook can call unmarkSong. After unmark, song removed from playedSongs, playedOrder, and nowPlaying if applicable.</verify>
  <done>useGameState exports unmarkSong action. Toggle behavior works: click played song → unmarks it.</done>
</task>

<task type="auto">
  <name>Task 3: Update SongChecklist to support toggle behavior</name>
  <files>musicbingo_host/src/components/SongChecklist.jsx, musicbingo_host/src/components/SongChecklist.css</files>
  <action>
Update SongChecklist component:

Modify the click handler to toggle played state:
- If song is NOT played: call onSongClick to mark as played + set now playing (existing)
- If song IS played: call onUnmarkSong to unmark it (new)

Add visual indicator that played songs can be clicked again:
- Subtle "click to undo" hint on hover for played songs
- Or cursor pointer to indicate clickability

Props update:
- Add onUnmarkSong prop for unmark callback
- Keep onSongClick for marking played

CSS update:
- Add hover state for played songs to show they're still interactive
- Maybe a subtle "undo" icon or tooltip on hover
  </action>
  <verify>Clicking an unplayed song marks it. Clicking a played song unmarks it. Visual feedback shows songs are toggleable.</verify>
  <done>SongChecklist supports toggle: click unplayed → mark, click played → unmark. Visual feedback on hover.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API server runs without errors
- [ ] DELETE /api/game/{id}/song/{song_id} removes song from played_songs
- [ ] Clicking unplayed song marks it as played (existing behavior preserved)
- [ ] Clicking played song unmarks it (new behavior)
- [ ] Call Board updates when song is unmarked
- [ ] Now Playing clears if the now-playing song is unmarked
- [ ] Scanner app sees unmark via polling
</verification>

<success_criteria>
- All UAT issues from 04-02-ISSUES.md addressed
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-host-view/04-02-FIX-SUMMARY.md`
</output>
