---
phase: 04-host-view
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - musicbingo_api/src/musicbingo_api/main.py
  - musicbingo_api/src/musicbingo_api/game_service.py
  - musicbingo_host/src/services/gameApi.js
  - musicbingo_host/src/hooks/useGameState.js
  - musicbingo_host/src/components/GameControls.jsx
  - musicbingo_host/src/components/GameControls.css
  - musicbingo_host/src/App.js
autonomous: true
---

<objective>
Add game control functionality with reset round capability for the host view.

Purpose: Allow DJ to reset played songs between rounds without reloading the game.
Output: GameControls component with Reset Round button, wired to new API endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-host-view/04-01-SUMMARY.md

# Existing source files (after 04-01)
@musicbingo_host/src/hooks/useGameState.js
@musicbingo_host/src/services/gameApi.js
@musicbingo_host/src/App.js

# API files
@musicbingo_api/src/musicbingo_api/main.py
@musicbingo_api/src/musicbingo_api/game_service.py
@musicbingo_api/src/musicbingo_api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reset_round endpoint to API</name>
  <files>musicbingo_api/src/musicbingo_api/main.py, musicbingo_api/src/musicbingo_api/game_service.py</files>
  <action>
Add reset_round method to GameService:
```python
def reset_round(self, game_id: UUID) -> GameState:
    """Reset played songs for a new round.

    Clears played_songs list but keeps cards and pattern.
    """
    game = self.get_game_or_raise(game_id)
    game.played_songs = []
    game.updated_at = datetime.now()
    return game
```

Add endpoint to main.py:
```python
@app.post(
    "/api/game/{game_id}/reset",
    response_model=GameStateResponse,
    responses={404: {"model": ErrorResponse}},
)
async def reset_round(game_id: UUID):
    """Reset played songs for a new round.

    Clears all played songs but preserves cards and pattern.
    Use when starting a new round with the same game.
    """
    try:
        service = get_game_service()
        game = service.reset_round(game_id)

        return GameStateResponse(
            game_id=game.game_id,
            status=game.status,
            playlist_size=len(game.playlist),
            played_songs=game.played_songs,
            played_count=len(game.played_songs),
            current_pattern=game.current_pattern,
            card_count=len(game.cards),
            created_at=game.created_at,
            updated_at=game.updated_at,
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
```
  </action>
  <verify>curl -X POST http://localhost:8000/api/game/{game_id}/reset returns GameStateResponse with empty played_songs array</verify>
  <done>POST /api/game/{id}/reset endpoint exists and clears played_songs</done>
</task>

<task type="auto">
  <name>Task 2: Add reset action to useGameState hook</name>
  <files>musicbingo_host/src/services/gameApi.js, musicbingo_host/src/hooks/useGameState.js</files>
  <action>
Add to gameApi.js:
```javascript
export async function resetRound(gameId) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/reset`, {
    method: 'POST',
  });
  if (!response.ok) throw new Error('Failed to reset round');
  return response.json();
}
```

Add to useGameState.js:
- resetRound action that:
  1. Calls gameApi.resetRound(gameId)
  2. Clears local playedSongs Set
  3. Clears local playedOrder array
  4. Clears nowPlaying state
  5. Handles errors gracefully
- Export resetRound in hook return
  </action>
  <verify>Hook can call resetRound. After reset, playedSongs empty, playedOrder empty, nowPlaying null.</verify>
  <done>useGameState exports resetRound action. Reset clears all play state.</done>
</task>

<task type="auto">
  <name>Task 3: Create GameControls component with Reset button</name>
  <files>musicbingo_host/src/components/GameControls.jsx, musicbingo_host/src/components/GameControls.css, musicbingo_host/src/App.js</files>
  <action>
Create GameControls component:

Props:
- onReset: function to call when reset confirmed
- playedCount: number of songs played (to show in confirmation)
- disabled: boolean (disable during loading/no game)

Display:
- "Reset Round" button with reset icon
- Confirmation dialog when clicked:
  - "Reset Round?"
  - "This will clear {playedCount} played songs and start fresh."
  - "Cancel" and "Reset" buttons
- Loading state while resetting

Use browser confirm() for simplicity (no modal library needed):
```javascript
const handleReset = () => {
  if (window.confirm(`Reset round? This will clear ${playedCount} played songs.`)) {
    onReset();
  }
};
```

Style:
- Danger/warning color for reset button (red/orange)
- Compact button for control bar placement
- Disabled state when no game loaded

Integrate into App.js:
- Add GameControls to header next to PatternSelector
- Wire onReset to resetRound action from hook
- Pass playedCount and disabled props
  </action>
  <verify>Reset button appears in header. Clicking shows confirmation. Confirming clears played songs and updates CallBoard/checklist.</verify>
  <done>GameControls component with Reset Round button. Confirmation before reset. Play state cleared after reset.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API server runs without errors
- [ ] POST /api/game/{id}/reset clears played_songs
- [ ] Reset button appears in host app header
- [ ] Reset confirmation dialog works
- [ ] After reset: CallBoard empty, checklist shows all songs unplayed, no "now playing"
- [ ] Scanner app sees reset via polling (played songs cleared)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- DJ can reset round between games without reloading
- Reset syncs across host and scanner apps
</success_criteria>

<output>
After completion, create `.planning/phases/04-host-view/04-02-SUMMARY.md`
</output>
