---
phase: 05-player-view
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - musicbingo_api/src/musicbingo_api/main.py
  - musicbingo_api/src/musicbingo_api/game_service.py
  - musicbingo_api/src/musicbingo_api/schemas.py
  - musicbingo_host/src/hooks/useGameState.js
  - musicbingo_host/src/services/gameApi.js
autonomous: true
---

<objective>
Add delayed song title reveal functionality - song titles hidden initially, revealed after configurable delay.

Purpose: Make the game more engaging - players must recognize songs by sound, not by reading the title.
Output: API support for reveal state, host control to reveal songs, player view respects reveal state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current API
@musicbingo_api/src/musicbingo_api/main.py
@musicbingo_api/src/musicbingo_api/game_service.py
@musicbingo_api/src/musicbingo_api/schemas.py

# Current hooks
@musicbingo_host/src/hooks/useGameState.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add revealed_songs to game state and API</name>
  <files>musicbingo_api/src/musicbingo_api/models.py, musicbingo_api/src/musicbingo_api/game_service.py, musicbingo_api/src/musicbingo_api/schemas.py, musicbingo_api/src/musicbingo_api/main.py</files>
  <action>
Add revealed_songs list to GameState model:
```python
revealed_songs: list[UUID] = field(default_factory=list)
```

Add reveal_song method to GameService:
```python
def reveal_song(self, game_id: UUID, song_id: str) -> GameState:
    """Mark a song as revealed (title can be shown on player view)."""
    game = self.get_game_or_raise(game_id)
    song_uuid = UUID(song_id)
    if song_uuid not in game.revealed_songs:
        game.revealed_songs.append(song_uuid)
        game.updated_at = datetime.now()
    return game
```

Add endpoint:
```python
@app.post("/api/game/{game_id}/reveal/{song_id}")
async def reveal_song(game_id: UUID, song_id: str):
    """Reveal a song title on the player view."""
```

Update GameStateResponse to include revealed_songs list.

Update reset_round to also clear revealed_songs.
  </action>
  <verify>curl POST /api/game/{id}/reveal/{song_id} adds song to revealed_songs, GET /state returns revealed_songs</verify>
  <done>API supports revealed_songs state and reveal endpoint</done>
</task>

<task type="auto">
  <name>Task 2: Add reveal functionality to useGameState hook</name>
  <files>musicbingo_host/src/services/gameApi.js, musicbingo_host/src/hooks/useGameState.js</files>
  <action>
Add to gameApi.js:
```javascript
export async function revealSong(gameId, songId) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/reveal/${songId}`, {
    method: 'POST',
  });
  if (!response.ok) throw new Error('Failed to reveal song');
  return response.json();
}
```

Add to useGameState:
- revealedSongs state (Set, like playedSongs)
- revealSong action that calls API and updates local state
- Update polling to sync revealed_songs from API
- Export revealedSongs and revealSong

Auto-reveal behavior:
- When a song is set as "now playing", start a reveal timer
- After REVEAL_DELAY seconds (default: 15), auto-call revealSong
- Store timer ref to cancel if song changes before reveal
- Clear timer on reset
  </action>
  <verify>Hook tracks revealed songs, auto-reveals after delay, syncs via polling</verify>
  <done>useGameState manages revealed songs with auto-reveal timer</done>
</task>

<task type="auto">
  <name>Task 3: Add manual reveal button to host view</name>
  <files>musicbingo_host/src/pages/HostView.jsx, musicbingo_host/src/components/SongChecklist.jsx, musicbingo_host/src/components/SongChecklist.css</files>
  <action>
Add reveal control to host interface:

Option A (preferred): Add "Reveal" button in the checklist for the now-playing song
- Shows only for now-playing song that isn't revealed yet
- Clicking reveals immediately (bypasses auto-timer)
- Shows "Revealed" checkmark after reveal

Option B: Keyboard shortcut (Space bar = reveal current song)

Update SongChecklist to show reveal state:
- Songs that are played but not revealed: show "?" or hidden indicator
- Songs that are revealed: show normally
- Now playing + not revealed: show "Reveal" button

Pass revealedSongs and revealSong from hook to component.
  </action>
  <verify>Host can manually reveal songs, reveal state visible in checklist</verify>
  <done>Host has manual reveal control, reveal state shown in UI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API server runs without errors
- [ ] POST /api/game/{id}/reveal/{song_id} adds to revealed_songs
- [ ] GET /api/game/{id}/state returns revealed_songs
- [ ] Reset clears revealed_songs
- [ ] Host view shows reveal button for now-playing song
- [ ] Auto-reveal triggers after 15 seconds
- [ ] Manual reveal works immediately
- [ ] Revealed state syncs to player view via polling
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Songs can be revealed manually or automatically
- Reveal state syncs between host and player
- Ready for 05-04 (Pattern Display)
</success_criteria>

<output>
After completion, create `.planning/phases/05-player-view/05-03-SUMMARY.md`
</output>
