---
phase: 01-local-backend-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - musicbingo_api/src/musicbingo_api/main.py
  - musicbingo_api/src/musicbingo_api/network.py
  - scripts/start-server.sh
autonomous: true
---

<objective>
Configure FastAPI server to run on DJ's laptop and be accessible from phone scanner on local WiFi network.

Purpose: Enable verification from phone by making API accessible on local network with proper CORS and discoverable IP address.
Output: Startup script that launches server on 0.0.0.0 and displays connection URL for scanner.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@musicbingo_api/src/musicbingo_api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CORS for local network access</name>
  <files>musicbingo_api/src/musicbingo_api/main.py</files>
  <action>
Update CORS middleware to accept connections from local network IPs:
- Add regex pattern for private network ranges: `192.168.*`, `10.*`, `172.16-31.*`
- Keep existing localhost and GitHub Pages origins
- Use `allow_origin_regex` instead of `allow_origins` for dynamic matching

Pattern should be: `r"^https?://(localhost|192\.168\.\d+\.\d+|10\.\d+\.\d+\.\d+|172\.(1[6-9]|2\d|3[01])\.\d+\.\d+)(:\d+)?$"`

Also allow the root IP without port for direct browser access.
  </action>
  <verify>Start server on 0.0.0.0:8000, make request from different origin - should not get CORS error</verify>
  <done>CORS accepts requests from any local network IP address</done>
</task>

<task type="auto">
  <name>Task 2: Create network utility module</name>
  <files>musicbingo_api/src/musicbingo_api/network.py</files>
  <action>
Create new module with function to get local IP address:

```python
import socket

def get_local_ip() -> str:
    """Get the local network IP address of this machine.

    Returns the IP that other devices on the same network can use to connect.
    Falls back to 127.0.0.1 if no network interface found.
    """
    try:
        # Create UDP socket to external address (doesn't actually send data)
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except Exception:
        return "127.0.0.1"
```

Add endpoint to main.py:
- `GET /api/network/info` - Returns `{"ip": "192.168.1.x", "port": 8000, "url": "http://192.168.1.x:8000"}`

This endpoint helps the scanner app discover the server URL.
  </action>
  <verify>curl localhost:8000/api/network/info returns JSON with local IP</verify>
  <done>Network info endpoint returns machine's local IP address</done>
</task>

<task type="auto">
  <name>Task 3: Create startup script with network display</name>
  <files>scripts/start-server.sh</files>
  <action>
Create bash script that:
1. Creates scripts/ directory if not exists
2. Determines local IP using Python one-liner or hostname -I
3. Starts uvicorn bound to 0.0.0.0:8000
4. Prints clear connection instructions before server starts

Script content:
```bash
#!/bin/bash
# Music Bingo Local Server Startup

# Get local IP
LOCAL_IP=$(python3 -c "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.connect(('8.8.8.8',80)); print(s.getsockname()[0]); s.close()" 2>/dev/null || echo "localhost")

echo ""
echo "======================================"
echo "  Music Bingo Server Starting..."
echo "======================================"
echo ""
echo "  Connect your phone scanner to:"
echo ""
echo "    http://${LOCAL_IP}:8000"
echo ""
echo "  API docs available at:"
echo "    http://${LOCAL_IP}:8000/docs"
echo ""
echo "======================================"
echo ""

# Start server bound to all interfaces
cd "$(dirname "$0")/.."
python3 -m uvicorn musicbingo_api.main:app --host 0.0.0.0 --port 8000 --reload
```

Make script executable with chmod +x.
  </action>
  <verify>Run ./scripts/start-server.sh - displays local IP and starts server accessible from other devices</verify>
  <done>Single command starts server and shows connection URL for phone</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./scripts/start-server.sh` starts server and displays local IP
- [ ] Server accessible at http://LOCAL_IP:8000 from another device on same network
- [ ] CORS allows requests from phone browser (no CORS errors in console)
- [ ] `GET /api/network/info` returns correct local IP
</verification>

<success_criteria>

- All tasks completed
- Server binds to 0.0.0.0 and accepts connections from local network
- Phone on same WiFi can reach the API
- DJ has simple startup command with clear connection instructions
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-backend-infrastructure/01-01-SUMMARY.md`
</output>
