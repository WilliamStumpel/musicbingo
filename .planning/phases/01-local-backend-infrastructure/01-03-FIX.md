---
phase: 01-local-backend-infrastructure
plan: 01-03-FIX
type: fix
wave: 1
depends_on: ["01-03"]
files_modified:
  - musicbingo_verify/src/App.js
  - musicbingo_verify/src/hooks/useScanner.js
autonomous: true
---

<objective>
Fix 1 UAT issue from plan 01-03.

Source: 01-03-ISSUES.md
Priority: 1 blocker

**UAT-001:** Scanner shows "Oops" error immediately on load after connecting to server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/01-local-backend-infrastructure/01-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/01-local-backend-infrastructure/01-03-PLAN.md

**Files to fix:**
@musicbingo_verify/src/App.js
@musicbingo_verify/src/hooks/useScanner.js
@musicbingo_verify/src/services/qrParser.js
</context>

<root_cause_analysis>
**Bug chain:**
1. After connecting, Scanner component mounts and initializes QR scanner
2. During camera initialization (or if camera fails), Scanner calls `onError` prop
3. App.js line 83-86 handles this by calling `handleScan(null)` — WRONG!
4. useScanner passes `null` to `parseQRData(null)`
5. qrParser.js throws "Invalid QR code: empty or non-string value"
6. Error displays immediately, user clicks "Try Again"
7. Scanner remounts, camera initializes, error triggers again → infinite loop

**Root cause:** App.js incorrectly routes Scanner errors through handleScan(null) instead of handling them separately. Scanner errors (camera issues) are different from scan result errors (invalid QR).
</root_cause_analysis>

<tasks>

<task type="auto">
  <name>Task 1: Fix Scanner error handling in App.js</name>
  <files>musicbingo_verify/src/App.js</files>
  <action>
Change the Scanner's onError prop to NOT call handleScan(null).

Current (broken):
```jsx
onError={(err) => {
  console.error('Scanner error:', err);
  handleScan(null); // This will trigger error handling — WRONG
}}
```

Fix: Remove the handleScan(null) call. Scanner errors (camera permission, camera not found) should just log to console, not trigger the QR parsing flow. The Scanner component already shows its own error UI for camera issues (see Scanner.jsx lines 98-103).

Updated:
```jsx
onError={(err) => {
  console.error('Scanner error:', err);
  // Scanner component handles its own error UI for camera issues
  // Don't trigger QR parsing - there's no QR code to parse
}}
```

This prevents the cascade where camera errors trigger "Invalid QR code" errors.
  </action>
  <verify>Start app, connect to server, scanner loads without immediate error</verify>
  <done>Scanner errors don't trigger QR parsing error flow</done>
</task>

<task type="auto">
  <name>Task 2: Add defensive null check in useScanner</name>
  <files>musicbingo_verify/src/hooks/useScanner.js</files>
  <action>
Add early return in handleScan for null/empty input as defense-in-depth.

In handleScan function, before setting processing state:
```javascript
const handleScan = async (qrString) => {
  // Guard: ignore null/empty scans (e.g., from scanner errors)
  if (!qrString || typeof qrString !== 'string') {
    console.warn('handleScan called with invalid input:', qrString);
    return;
  }

  setIsProcessing(true);
  // ... rest of function
```

This prevents the error cascade even if something else accidentally calls handleScan with invalid data.
  </action>
  <verify>handleScan with null input returns early without error</verify>
  <done>useScanner gracefully handles null/empty input</done>
</task>

</tasks>

<verification>
Before declaring fix complete:
- [ ] App starts without errors
- [ ] Connect to server works
- [ ] Scanner loads without immediate "Oops" error
- [ ] Camera permission prompt appears (or camera starts)
- [ ] Scanning a valid QR code still works
- [ ] Page refresh maintains connection and scanner works
</verification>

<success_criteria>
- UAT-001 resolved: Scanner loads after server connection without errors
- No regression: Valid QR code scanning still works
- Defense-in-depth: handleScan ignores invalid input gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-backend-infrastructure/01-03-FIX-SUMMARY.md`
</output>
