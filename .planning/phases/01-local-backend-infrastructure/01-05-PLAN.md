---
phase: 01-local-backend-infrastructure
plan: 01-05
title: Venue Deployment Infrastructure
type: feature
wave: 1
depends_on: ["01-04"]
files_modified:
  - musicbingo_host/src/components/ConnectionInfo.jsx
  - musicbingo_host/src/components/ConnectionInfo.css
  - musicbingo_host/src/services/gameApi.js
  - musicbingo_verify/src/App.js
  - musicbingo_verify/src/App.css
  - musicbingo_verify/src/components/Scanner.css
  - musicbingo_api/src/musicbingo_api/main.py
  - start-venue.sh (new)
autonomous: false
---

<objective>
Enable smooth deployment at venues with iOS camera support. The DJ needs a one-click startup process that works at any venue regardless of IP address, with HTTPS for iOS Safari camera access.

**Problem:** iOS Safari requires HTTPS for camera access. Local network IPs change at each venue, making certificate management impractical.

**Solution:**
1. Deploy scanner PWA to Vercel (permanent HTTPS URL)
2. Use ngrok for API tunneling (HTTPS, works at any venue)
3. Auto-detect ngrok URL in host app
4. One-click startup script
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Discovered during UAT of 01-04:**
- iOS Safari blocks camera access on HTTP
- Changing IPs at venues makes local certificates impractical
- Manual URL entry is poor UX for DJ workflow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API endpoint in gameApi.js</name>
  <files>musicbingo_host/src/services/gameApi.js</files>
  <action>
Change getServerInfo endpoint from `/api/server-info` to `/api/network/info` (the actual endpoint).
  </action>
  <verify>API call succeeds and returns network IP</verify>
  <done>Endpoint fixed</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-connect via URL param to scanner</name>
  <files>musicbingo_verify/src/App.js</files>
  <action>
Read `?server=` URL parameter on mount. If present:
1. Attempt health check to that server
2. On success, save to localStorage and connect
3. Clean up URL param after connection
  </action>
  <verify>Scanner auto-connects when opened with ?server= param</verify>
  <done>Auto-connect implemented</done>
</task>

<task type="auto">
  <name>Task 3: Fix iOS Safari viewport issues</name>
  <files>musicbingo_verify/src/App.css, musicbingo_verify/src/components/Scanner.css</files>
  <action>
- Add `100dvh` (dynamic viewport height) for iOS Safari
- Fix scanner container to use flex instead of fixed height
- Wrap scan tab content in flex container
  </action>
  <verify>Tabs visible on iOS Safari, scanner doesn't overflow</verify>
  <done>iOS layout fixed</done>
</task>

<task type="auto">
  <name>Task 4: Deploy scanner to Vercel</name>
  <files>musicbingo_verify/*</files>
  <action>
1. Fix ESLint warnings for CI build
2. Deploy to Vercel: `vercel --prod`
3. Result: https://musicbingo-verify.vercel.app
  </action>
  <verify>Scanner accessible at Vercel URL with HTTPS</verify>
  <done>Scanner deployed to Vercel</done>
</task>

<task type="auto">
  <name>Task 5: Update ConnectionInfo for Vercel + ngrok</name>
  <files>musicbingo_host/src/components/ConnectionInfo.jsx, musicbingo_host/src/components/ConnectionInfo.css</files>
  <action>
1. Use Vercel scanner URL as base
2. Add ngrok toggle with URL input
3. Auto-detect ngrok URL from localhost:4040/api/tunnels
4. Add refresh button to re-detect ngrok
5. Persist ngrok URL to localStorage
  </action>
  <verify>QR modal auto-detects ngrok and generates correct scanner URL</verify>
  <done>ConnectionInfo updated with ngrok auto-detection</done>
</task>

<task type="auto">
  <name>Task 6: Add HTTPS protocol detection to API</name>
  <files>musicbingo_api/src/musicbingo_api/main.py</files>
  <action>
Update /api/network/info endpoint to detect request scheme (http/https) and return appropriate protocol in URL.
  </action>
  <verify>API returns https:// when accessed via HTTPS</verify>
  <done>Protocol detection added</done>
</task>

<task type="auto">
  <name>Task 7: Create one-click venue startup script</name>
  <files>start-venue.sh (new)</files>
  <action>
Create shell script that:
1. Starts API server
2. Starts ngrok tunnel
3. Extracts and displays ngrok URL
4. Starts host app
5. Handles Ctrl+C cleanup
  </action>
  <verify>./start-venue.sh starts all services with one command</verify>
  <done>Startup script created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API endpoint fixed
- [ ] Scanner auto-connects from URL param
- [ ] iOS Safari shows tabs correctly
- [ ] Scanner deployed to Vercel
- [ ] ngrok auto-detected in QR modal
- [ ] start-venue.sh works
- [ ] Full flow tested on iPhone: scan QR → auto-connect → camera works
</verification>

<success_criteria>
- One-click startup: ./start-venue.sh
- iOS camera works via ngrok + Vercel
- No manual URL copy-paste required
- Works at any venue regardless of IP
</success_criteria>

<output>
After completion, create `.planning/phases/01-local-backend-infrastructure/01-05-SUMMARY.md`
</output>
