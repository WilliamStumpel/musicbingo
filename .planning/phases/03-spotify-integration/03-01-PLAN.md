---
phase: 03-spotify-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - musicbingo_host/package.json
  - musicbingo_host/src/App.js
  - musicbingo_host/src/services/spotifyAuth.js
  - musicbingo_host/src/hooks/useSpotifyAuth.js
  - musicbingo_host/src/components/SpotifyLogin.jsx
  - musicbingo_host/public/index.html
autonomous: true
---

<objective>
Create the Music Bingo Host application with Spotify OAuth PKCE authentication.

Purpose: Establish the foundation for DJ playback controls with secure Spotify authentication that works for local/desktop apps without requiring a client secret.

Output: New React app `musicbingo_host` with working Spotify login/logout, token storage, and automatic token refresh.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spotify-integration/DISCOVERY.md
@musicbingo_verify/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create musicbingo_host React app</name>
  <files>musicbingo_host/package.json, musicbingo_host/src/App.js, musicbingo_host/public/index.html</files>
  <action>
Create new React app in musicbingo_host/ directory using Create React App pattern (copy structure from musicbingo_verify but fresh):

1. Create directory structure:
   - musicbingo_host/
   - musicbingo_host/public/
   - musicbingo_host/src/
   - musicbingo_host/src/components/
   - musicbingo_host/src/services/
   - musicbingo_host/src/hooks/

2. Create package.json with:
   - name: "musicbingo_host"
   - React 19 (same as musicbingo_verify)
   - react-scripts 5.0.1
   - Scripts: start, build, test

3. Create minimal App.js that renders "Music Bingo Host" header

4. Create public/index.html with title "Music Bingo Host"

5. Create src/index.js entry point

Use same React version as musicbingo_verify for consistency. Do NOT add Spotify SDK script tag yet - that comes in Plan 03-02.
  </action>
  <verify>cd musicbingo_host && npm install && npm start (app runs on localhost:3000)</verify>
  <done>React app runs, shows "Music Bingo Host" header</done>
</task>

<task type="auto">
  <name>Task 2: Implement Spotify PKCE auth service</name>
  <files>musicbingo_host/src/services/spotifyAuth.js</files>
  <action>
Create spotifyAuth.js service module implementing PKCE OAuth flow:

1. Constants:
   - CLIENT_ID: Read from environment variable REACT_APP_SPOTIFY_CLIENT_ID
   - REDIRECT_URI: window.location.origin + '/callback'
   - SCOPES: 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state'
   - AUTH_URL: 'https://accounts.spotify.com/authorize'
   - TOKEN_URL: 'https://accounts.spotify.com/api/token'

2. PKCE helpers:
   - generateRandomString(length) - crypto random string 43-128 chars
   - sha256(plain) - hash using crypto.subtle.digest
   - base64urlencode(buffer) - base64url encode (no padding, - for +, _ for /)
   - generateCodeChallenge(verifier) - SHA256 hash of verifier, base64url encoded

3. Auth flow functions:
   - initiateLogin() - Generate verifier, store in localStorage, redirect to Spotify
   - handleCallback(code) - Exchange code for tokens using stored verifier
   - refreshAccessToken() - Use refresh_token to get new access_token
   - logout() - Clear all stored tokens

4. Token storage (localStorage keys):
   - 'spotify_code_verifier' - temporary during auth
   - 'spotify_access_token'
   - 'spotify_refresh_token'
   - 'spotify_token_expiry' - timestamp when token expires

5. Token helpers:
   - getAccessToken() - return stored token if valid, auto-refresh if expired
   - isAuthenticated() - check if valid token exists
   - getTokenExpiresIn() - seconds until expiry

IMPORTANT: Use http://127.0.0.1:3000/callback for local dev (Spotify allows 127.0.0.1 but not localhost).
  </action>
  <verify>Import spotifyAuth in App.js and log isAuthenticated() - no errors in console</verify>
  <done>All auth functions exported and importable without errors</done>
</task>

<task type="auto">
  <name>Task 3: Create login UI with useSpotifyAuth hook</name>
  <files>musicbingo_host/src/hooks/useSpotifyAuth.js, musicbingo_host/src/components/SpotifyLogin.jsx, musicbingo_host/src/App.js</files>
  <action>
1. Create useSpotifyAuth.js hook:
   - State: isAuthenticated, isLoading, error, user (null or {email})
   - On mount: Check if URL has ?code= (callback), handle it
   - On mount: Check existing token validity
   - Expose: login(), logout(), isAuthenticated, isLoading, error
   - Auto-refresh: Set timeout to refresh token 5 minutes before expiry

2. Create SpotifyLogin.jsx component:
   - If not authenticated: Show "Connect to Spotify" button
   - If loading: Show spinner
   - If error: Show error message with retry button
   - If authenticated: Show "Logged in as {email}" and Logout button
   - Style with inline styles or simple CSS (green Spotify color #1DB954)

3. Update App.js:
   - Use useSpotifyAuth hook
   - Add route handling for /callback (check window.location.pathname)
   - Show SpotifyLogin component
   - When authenticated, show "Ready to play music!" placeholder

4. Create .env.example with:
   REACT_APP_SPOTIFY_CLIENT_ID=your_client_id_here

Note: User will need to:
1. Create app at https://developer.spotify.com/dashboard
2. Add http://127.0.0.1:3000/callback as redirect URI
3. Copy client ID to .env file
  </action>
  <verify>npm start, click login, redirect to Spotify, authorize, redirect back, see "Logged in as {email}"</verify>
  <done>Full login/logout flow works, token persists across page refresh, auto-refresh scheduled</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd musicbingo_host && npm install` succeeds
- [ ] `npm start` runs without errors
- [ ] Login redirects to Spotify authorization
- [ ] Callback handles code exchange correctly
- [ ] Token stored in localStorage
- [ ] Page refresh maintains logged-in state
- [ ] Logout clears tokens and shows login button
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>
- musicbingo_host React app created and runs
- PKCE OAuth flow implemented (no client secret needed)
- Login/logout works end-to-end with Spotify
- Tokens stored securely in localStorage
- Auto-refresh prevents token expiry during session
- .env.example documents required configuration
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-01-SUMMARY.md`
</output>
