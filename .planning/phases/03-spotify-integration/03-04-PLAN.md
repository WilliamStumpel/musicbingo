---
phase: 03-spotify-integration
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - musicbingo_host/src/services/playlistQueue.js
  - musicbingo_host/src/hooks/usePlaylistQueue.js
  - musicbingo_host/src/components/PlaylistView.jsx
  - musicbingo_host/src/components/PlaylistView.css
  - musicbingo_host/src/App.js
autonomous: true
---

<objective>
Implement playlist queue management with shuffle toggle, next/previous navigation, and direct song selection.

Purpose: DJs need full control over song order - random shuffle for variety, sequential for planned sets, and ability to jump to any song.

Output: Playlist view with all songs, shuffle toggle, next/prev controls, click-to-play, and played song tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-spotify-integration/DISCOVERY.md
@.planning/phases/03-spotify-integration/03-02-SUMMARY.md
@musicbingo_api/src/musicbingo_api/main.py
@musicbingo_api/src/musicbingo_api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create playlist queue service and hook</name>
  <files>musicbingo_host/src/services/playlistQueue.js, musicbingo_host/src/hooks/usePlaylistQueue.js</files>
  <action>
1. Create playlistQueue.js service:

   State (module-level):
   - playlist: [] (array of { songId, title, artist, uri })
   - playOrder: [] (indices into playlist, shuffled or sequential)
   - currentIndex: -1 (index into playOrder, -1 = nothing playing)
   - playedSongs: Set() (song IDs that have been played)
   - isShuffled: false
   - gameId: null

   Functions:
   - loadPlaylist(songs, gameId) - Load songs from game
     * songs: array of { song_id, title, artist, spotify_uri }
     * Store playlist, reset playOrder to [0,1,2,...n-1], reset currentIndex to -1
     * Clear playedSongs
     * Store gameId for API calls

   - shuffle() - Randomize playOrder using Fisher-Yates
     * Keep already-played songs in their played positions
     * Only shuffle remaining songs
     * Set isShuffled = true

   - unshuffle() - Reset to sequential order
     * playOrder = [0,1,2,...n-1]
     * Set isShuffled = false
     * Maintain currentIndex pointing to same song

   - getCurrentSong() - Get current song object or null
   - getNextSong() - Get next song without advancing
   - getPreviousSong() - Get previous song without going back

   - next() - Advance to next song
     * Increment currentIndex
     * Add song to playedSongs
     * Return new current song or null if at end

   - previous() - Go back to previous song
     * Decrement currentIndex (min 0)
     * Return new current song

   - jumpTo(songIndex) - Jump to specific song in playlist
     * Find song's position in playOrder
     * Set currentIndex to that position
     * Add to playedSongs
     * Return song

   - markPlayed(songId) - Mark song as played (for API sync)
   - isPlayed(songId) - Check if song was played
   - getPlayedSongs() - Get array of played song IDs
   - getRemainingCount() - Count of unplayed songs

   - getPlaylistForDisplay() - Get playlist with play state
     * Return array of { ...song, isPlayed, isCurrent, queuePosition }

2. Create usePlaylistQueue.js hook:

   State:
   - playlist: array from service
   - currentSong: current song object or null
   - isShuffled: boolean
   - playedCount: number
   - remainingCount: number
   - isLoading: boolean
   - error: string | null

   Functions:
   - loadFromGame(gameId) - Fetch game from API, load playlist
     * GET /api/game/{gameId}/state to get playlist
     * Map songs to include spotify_uri (construct from song metadata)
     * Call playlistQueue.loadPlaylist()

   - shuffle() / unshuffle() - Toggle shuffle mode
   - next() / previous() - Navigate playlist
   - jumpTo(index) - Play specific song
   - getCurrentSong() - Get current song

   Integration with clipPlayer:
   - When next/previous/jumpTo called, also call clipPlayer.playClip() if available
   - Pass current song URI to player

   Note: For now, construct Spotify URI as spotify:track:{songId} - this assumes song_id in game data is Spotify track ID. If not, we'll need to add spotify_uri to song data in Phase 4.
  </action>
  <verify>Load test playlist, verify shuffle changes order, next/previous work, jumpTo works</verify>
  <done>Queue management works, shuffle randomizes unplayed songs, navigation correct</done>
</task>

<task type="auto">
  <name>Task 2: Create PlaylistView UI component</name>
  <files>musicbingo_host/src/components/PlaylistView.jsx, musicbingo_host/src/components/PlaylistView.css, musicbingo_host/src/App.js</files>
  <action>
1. Create PlaylistView.jsx component:

   Header section:
   - Game name (from loaded game)
   - Shuffle toggle button (shows current state)
   - Stats: "X of Y songs played"
   - "Load Game" dropdown/button to select game

   Song list (scrollable):
   - Each row shows:
     * Queue position number (or checkmark if played)
     * Song title
     * Artist name
     * Play button (or "Playing" indicator if current)
   - Current song highlighted with accent color
   - Played songs dimmed/grayed with strikethrough or checkmark
   - Click anywhere on row to jump to that song

   Queue controls (bottom bar):
   - Previous button (disabled if at start)
   - Current song info (title - artist)
   - Next button (disabled if at end)
   - Remaining count badge

   Integration:
   - On song click: call jumpTo(index), then play clip
   - On next/previous: navigate and play clip
   - On shuffle toggle: call shuffle() or unshuffle()

2. Create PlaylistView.css:
   - Scrollable list with fixed header and footer
   - Row hover states
   - Current song highlight (#1DB954 border or background)
   - Played song styling (opacity 0.5, strikethrough)
   - Smooth transitions for state changes

3. Update App.js:
   - Add PlaylistView component
   - Add game selector (dropdown of available games from /api/games)
   - When game selected: loadFromGame(gameId)
   - Connect playlist queue to clip player:
     * When playlist plays a song, use clipPlayer.playClip()
   - Layout: PlayerControls on left/top, PlaylistView on right/bottom

4. Add game loading:
   - Fetch /api/games to get list of available games
   - Show dropdown to select game
   - On select: GET /api/games/load/{filename} then load playlist

Note: The backend returns songs without spotify_uri. For testing, you can:
   - Use a test playlist with known Spotify track IDs as song_ids
   - Or hardcode a few test Spotify URIs for demo
   - Phase 4 will properly integrate Spotify playlist import
  </action>
  <verify>Load a game, see playlist, click shuffle, click song to play, use next/prev, verify played tracking</verify>
  <done>Full playlist UI works, shuffle toggles, song selection plays clips, progress tracked</done>
</task>

<task type="auto">
  <name>Task 3: Sync played songs with backend</name>
  <files>musicbingo_host/src/hooks/usePlaylistQueue.js, musicbingo_host/src/services/playlistQueue.js</files>
  <action>
1. Update usePlaylistQueue to sync with API:

   When a song is played (via next, previous, or jumpTo):
   - Call POST /api/game/{gameId}/song-played with { song_id }
   - This updates backend state for win verification

   On load from game:
   - GET /api/game/{gameId}/state
   - Read played_songs array from response
   - Mark those songs as played in local queue

2. Add error handling:
   - If API call fails, show toast/notification
   - Continue local operation (don't block on API failure)
   - Retry failed syncs on next song play

3. Update playlistQueue.js:
   - Add syncPlayedToApi(songId, gameId) function
   - Add loadPlayedFromApi(playedSongIds) function

This ensures the QR scanner knows which songs have been played for win verification.
  </action>
  <verify>Play songs, check /api/game/{id}/state shows them in played_songs</verify>
  <done>Played songs sync to backend, scanner can verify wins correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Games load from /api/games endpoint
- [ ] Playlist displays all songs from game
- [ ] Shuffle randomizes song order
- [ ] Unshuffle restores original order
- [ ] Click on song plays that song
- [ ] Next button advances to next song
- [ ] Previous button goes back
- [ ] Played songs visually distinguished
- [ ] Current song highlighted
- [ ] Played songs sync to backend API
- [ ] Stats (X of Y played) update correctly
</verification>

<success_criteria>
- Load playlist from any game in games/ directory
- Shuffle mode randomizes unplayed songs
- Sequential mode plays in original order
- Direct song selection works (click to play)
- Next/previous navigation works
- Played songs tracked and visually indicated
- Backend synced for win verification
- Full music player experience for DJ
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-04-SUMMARY.md`
</output>
