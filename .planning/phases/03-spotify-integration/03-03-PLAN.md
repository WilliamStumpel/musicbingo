---
phase: 03-spotify-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - musicbingo_host/src/services/clipPlayer.js
  - musicbingo_host/src/hooks/useClipPlayer.js
  - musicbingo_host/src/components/ClipSettings.jsx
  - musicbingo_host/src/App.js
autonomous: true
---

<objective>
Implement song clip configuration for music bingo gameplay - starting songs at a specific offset and auto-stopping after a configured duration.

Purpose: Music bingo plays short clips (not full songs) starting partway through to make the game more challenging. DJs need control over clip start point and duration.

Output: Clip player that starts songs at configured offset (default 30s) and auto-stops after configured duration (default 30s for normal, 15s for lightning).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-spotify-integration/DISCOVERY.md
@.planning/phases/03-spotify-integration/03-02-SUMMARY.md
@musicbingo_host/src/services/spotifyPlayer.js
@musicbingo_host/src/hooks/useSpotifyPlayer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clip player service with auto-stop timer</name>
  <files>musicbingo_host/src/services/clipPlayer.js, musicbingo_host/src/hooks/useClipPlayer.js</files>
  <action>
1. Create clipPlayer.js service:

   Default settings:
   - DEFAULT_START_OFFSET_MS = 30000 (30 seconds into song)
   - DEFAULT_CLIP_DURATION_MS = 30000 (30 second clip)
   - LIGHTNING_CLIP_DURATION_MS = 15000 (15 second clip for lightning rounds)

   State (module-level):
   - clipTimer: null (setTimeout reference)
   - clipStartTime: null (when current clip started)
   - clipDuration: null (current clip duration)
   - onClipEndCallback: null

   Functions:
   - setClipEndCallback(callback) - Register callback for when clip ends

   - playClip(trackUri, options = {}) - Play a song clip
     * options.startOffset (default: DEFAULT_START_OFFSET_MS)
     * options.duration (default: DEFAULT_CLIP_DURATION_MS)
     * Call spotifyPlayer.playTrack(trackUri, startOffset)
     * Set clipStartTime = Date.now()
     * Set clipDuration = duration
     * Start timer: clipTimer = setTimeout(stopClip, duration)
     * Return { startOffset, duration }

   - stopClip() - Stop current clip
     * Clear clipTimer if exists
     * Call spotifyPlayer.pause()
     * Call onClipEndCallback if set
     * Reset clipStartTime, clipDuration

   - getClipProgress() - Get current clip progress
     * If no clip playing, return null
     * Return { elapsed: Date.now() - clipStartTime, total: clipDuration, remaining: clipDuration - elapsed }

   - cancelClipTimer() - Cancel auto-stop without pausing
     * Clear clipTimer
     * Useful if user manually pauses

   - extendClip(additionalMs) - Add time to current clip
     * Clear current timer
     * Set new timer with remaining + additionalMs

2. Create useClipPlayer.js hook:

   State:
   - clipProgress: { elapsed, total, remaining } | null
   - isClipPlaying: boolean
   - clipSettings: { startOffset, duration, mode: 'normal' | 'lightning' }

   Functions:
   - playClip(trackUri) - Play with current settings
   - stopClip() - Stop current clip
   - setClipMode(mode) - 'normal' (30s) or 'lightning' (15s)
   - setStartOffset(ms) - Custom start offset
   - setClipDuration(ms) - Custom duration

   Effects:
   - Update clipProgress every 100ms when clip is playing
   - Listen for clip end events
   - Persist settings to localStorage

   Settings storage key: 'musicbingo_clip_settings'
  </action>
  <verify>Import useClipPlayer, play a clip, verify it auto-stops after duration</verify>
  <done>Clips play from offset, auto-stop after duration, progress tracking works</done>
</task>

<task type="auto">
  <name>Task 2: Create ClipSettings UI and integrate with player</name>
  <files>musicbingo_host/src/components/ClipSettings.jsx, musicbingo_host/src/components/ClipSettings.css, musicbingo_host/src/App.js</files>
  <action>
1. Create ClipSettings.jsx component:

   Layout:
   - Mode selector (toggle buttons):
     * "Normal" (30s clips) - selected state highlighted
     * "Lightning" (15s clips)

   - Start offset control:
     * Label: "Start songs at:"
     * Input: number field in seconds (default 30)
     * Range: 0-60 seconds
     * Helper text: "seconds into the song"

   - Duration control:
     * Label: "Clip length:"
     * Display current duration based on mode
     * For custom: number field in seconds
     * Range: 5-60 seconds

   - Clip progress display (when playing):
     * Progress bar showing elapsed/total
     * Time remaining countdown
     * "CLIP PLAYING" indicator with pulsing animation

   - Preview button:
     * "Test Clip" button to play a sample with current settings
     * Use same test track as 03-02

2. Create ClipSettings.css:
   - Consistent with PlayerControls styling
   - Toggle buttons with active state
   - Countdown animation for time remaining
   - Pulsing indicator for clip playing

3. Update App.js:
   - Add ClipSettings component below PlayerControls
   - Connect useClipPlayer hook
   - Replace test play button with clip-based playback
   - Show clip progress when clip is playing

4. Modify PlayerControls to integrate with clip mode:
   - When clip is playing, show clip progress instead of song progress
   - Add "Stop Clip" button that appears during clip playback
   - Disable seek during clip mode (optional, or allow but warn)
  </action>
  <verify>Set mode to Lightning, set offset to 45s, play test clip, verify it starts at 45s and stops after 15s</verify>
  <done>Clip settings UI works, mode toggle works, custom offset/duration works, auto-stop reliable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Normal mode plays 30-second clips
- [ ] Lightning mode plays 15-second clips
- [ ] Start offset is configurable (0-60s)
- [ ] Clip duration is configurable (5-60s)
- [ ] Auto-stop timer is accurate (within 500ms)
- [ ] Clip progress updates smoothly
- [ ] Settings persist across page refresh
- [ ] Stop Clip button works
- [ ] Mode switching works without issues
</verification>

<success_criteria>
- Clips start at configured offset (not beginning of song)
- Clips auto-stop after configured duration
- Normal mode: 30s clips starting at 30s
- Lightning mode: 15s clips starting at 30s
- Settings UI is intuitive
- Settings persist in localStorage
- Smooth progress indication during clip playback
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-03-SUMMARY.md`
</output>
