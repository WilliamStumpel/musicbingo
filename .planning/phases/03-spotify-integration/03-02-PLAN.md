---
phase: 03-manual-playback
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - musicbingo_host/src/App.js
  - musicbingo_host/src/App.css
  - musicbingo_host/src/components/SongChecklist.jsx
  - musicbingo_host/src/components/SongChecklist.css
  - musicbingo_host/src/hooks/useGameState.js
  - musicbingo_host/src/services/gameApi.js
autonomous: true
---

<objective>
Create host checklist view for manually marking songs as played.

Purpose: Replace the streaming player UI with a sortable, searchable song checklist that syncs with the backend API.

Output: Host app shows song list with sort/search/filter, tap to mark played, real-time sync.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-spotify-integration/DISCOVERY.md
@musicbingo_host/src/App.js
@musicbingo_api/src/musicbingo_api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up old Spotify code and create game API service</name>
  <files>musicbingo_host/src/services/gameApi.js</files>
  <action>
1. Delete old Spotify-related files (if they exist):
   - src/services/spotifyAuth.js
   - src/services/spotifyPlayer.js
   - src/services/appleMusicAuth.js
   - src/services/appleMusicPlayer.js
   - src/hooks/useSpotifyAuth.js
   - src/hooks/useSpotifyPlayer.js
   - src/hooks/useAppleMusic.js
   - src/hooks/useAppleMusicPlayer.js
   - src/components/SpotifyLogin.jsx
   - src/components/AppleMusicLogin.jsx
   - src/components/PlayerControls.jsx
   - src/components/PlayerControls.css

2. Create gameApi.js service:

```javascript
/**
 * Game API service for communicating with the backend.
 */

const API_BASE = process.env.REACT_APP_API_URL || 'http://127.0.0.1:8000';

/**
 * Get list of available games.
 */
export async function getGames() {
  const response = await fetch(`${API_BASE}/api/games`);
  if (!response.ok) throw new Error('Failed to fetch games');
  const data = await response.json();
  return data.games || [];
}

/**
 * Load a game by filename.
 */
export async function loadGame(filename) {
  const response = await fetch(`${API_BASE}/api/games/load/${filename}`);
  if (!response.ok) throw new Error('Failed to load game');
  return response.json();
}

/**
 * Get current game state (played songs, etc.).
 */
export async function getGameState(gameId) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/state`);
  if (!response.ok) {
    // State endpoint might not exist yet, return empty state
    if (response.status === 404) {
      return { played_songs: [] };
    }
    throw new Error('Failed to get game state');
  }
  return response.json();
}

/**
 * Mark a song as played or unplayed.
 */
export async function markSongPlayed(gameId, songId, played = true) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/mark-song`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ song_id: songId, played })
  });
  if (!response.ok) throw new Error('Failed to mark song');
  return response.json();
}

/**
 * Poll for game state updates.
 * Returns the current played_songs array.
 */
export async function pollGameState(gameId) {
  try {
    const state = await getGameState(gameId);
    return state.played_songs || [];
  } catch (e) {
    console.error('Poll failed:', e);
    return null; // Return null on error, don't throw
  }
}
```
  </action>
  <verify>gameApi.js created, no import errors</verify>
  <done>Old code cleaned up, API service created</done>
</task>

<task type="auto">
  <name>Task 2: Create useGameState hook</name>
  <files>musicbingo_host/src/hooks/useGameState.js</files>
  <action>
Create useGameState.js hook for managing game state with polling:

```javascript
import { useState, useEffect, useCallback, useRef } from 'react';
import * as gameApi from '../services/gameApi';

const POLL_INTERVAL = 2000; // 2 seconds

export function useGameState() {
  const [games, setGames] = useState([]);
  const [currentGame, setCurrentGame] = useState(null);
  const [songs, setSongs] = useState([]);
  const [playedSongs, setPlayedSongs] = useState(new Set());
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const pollRef = useRef(null);
  const gameIdRef = useRef(null);

  // Load available games
  const loadGames = useCallback(async () => {
    try {
      const gameList = await gameApi.getGames();
      setGames(gameList);
    } catch (e) {
      setError(e.message);
    }
  }, []);

  // Load a specific game
  const loadGame = useCallback(async (filename) => {
    setIsLoading(true);
    setError(null);

    try {
      const game = await gameApi.loadGame(filename);
      setCurrentGame(game);
      setSongs(game.songs || []);
      gameIdRef.current = filename;

      // Get initial state
      const state = await gameApi.getGameState(filename);
      setPlayedSongs(new Set(state.played_songs || []));
    } catch (e) {
      setError(e.message);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Toggle song played status
  const toggleSongPlayed = useCallback(async (songId) => {
    const gameId = gameIdRef.current;
    if (!gameId) return;

    const isPlayed = playedSongs.has(songId);
    const newPlayed = !isPlayed;

    // Optimistic update
    setPlayedSongs(prev => {
      const next = new Set(prev);
      if (newPlayed) {
        next.add(songId);
      } else {
        next.delete(songId);
      }
      return next;
    });

    // Sync to API
    try {
      await gameApi.markSongPlayed(gameId, songId, newPlayed);
    } catch (e) {
      // Revert on error
      setPlayedSongs(prev => {
        const next = new Set(prev);
        if (newPlayed) {
          next.delete(songId);
        } else {
          next.add(songId);
        }
        return next;
      });
      setError(e.message);
    }
  }, [playedSongs]);

  // Start polling for updates
  useEffect(() => {
    if (!gameIdRef.current) return;

    const poll = async () => {
      const played = await gameApi.pollGameState(gameIdRef.current);
      if (played !== null) {
        setPlayedSongs(new Set(played));
      }
    };

    pollRef.current = setInterval(poll, POLL_INTERVAL);

    return () => {
      if (pollRef.current) {
        clearInterval(pollRef.current);
      }
    };
  }, [currentGame]);

  // Load games on mount
  useEffect(() => {
    loadGames();
  }, [loadGames]);

  // Stats
  const playedCount = playedSongs.size;
  const totalCount = songs.length;

  return {
    // State
    games,
    currentGame,
    songs,
    playedSongs,
    playedCount,
    totalCount,
    isLoading,
    error,

    // Actions
    loadGame,
    toggleSongPlayed,
    refreshGames: loadGames,
  };
}
```
  </action>
  <verify>Hook imports without errors</verify>
  <done>useGameState hook created with polling</done>
</task>

<task type="auto">
  <name>Task 3: Create SongChecklist component</name>
  <files>musicbingo_host/src/components/SongChecklist.jsx, musicbingo_host/src/components/SongChecklist.css</files>
  <action>
1. Create SongChecklist.jsx:

```jsx
import React, { useState, useMemo } from 'react';
import './SongChecklist.css';

// Sort options
const SORT_OPTIONS = {
  TITLE_ASC: { field: 'title', dir: 'asc', label: 'Title A-Z' },
  TITLE_DESC: { field: 'title', dir: 'desc', label: 'Title Z-A' },
  ARTIST_ASC: { field: 'artist', dir: 'asc', label: 'Artist A-Z' },
  ARTIST_DESC: { field: 'artist', dir: 'desc', label: 'Artist Z-A' },
};

export function SongChecklist({
  songs,
  playedSongs,
  onTogglePlayed,
  playedCount,
  totalCount,
}) {
  const [searchQuery, setSearchQuery] = useState('');
  const [sortKey, setSortKey] = useState('TITLE_ASC');

  // Filter and sort songs
  const displayedSongs = useMemo(() => {
    let result = [...songs];

    // Filter by search query
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      result = result.filter(song =>
        song.title.toLowerCase().includes(query) ||
        song.artist.toLowerCase().includes(query)
      );
    }

    // Sort
    const sort = SORT_OPTIONS[sortKey];
    result.sort((a, b) => {
      const aVal = a[sort.field].toLowerCase();
      const bVal = b[sort.field].toLowerCase();
      const cmp = aVal.localeCompare(bVal);
      return sort.dir === 'asc' ? cmp : -cmp;
    });

    return result;
  }, [songs, searchQuery, sortKey]);

  const handleSortChange = (e) => {
    setSortKey(e.target.value);
  };

  const handleSearchChange = (e) => {
    setSearchQuery(e.target.value);
  };

  const clearSearch = () => {
    setSearchQuery('');
  };

  return (
    <div className="song-checklist">
      {/* Header */}
      <div className="checklist-header">
        <div className="stats">
          <span className="played-count">{playedCount}</span>
          <span className="total-count">/ {totalCount} played</span>
        </div>
      </div>

      {/* Controls */}
      <div className="checklist-controls">
        {/* Search */}
        <div className="search-box">
          <input
            type="text"
            placeholder="Search songs..."
            value={searchQuery}
            onChange={handleSearchChange}
            className="search-input"
          />
          {searchQuery && (
            <button className="clear-search" onClick={clearSearch}>
              ×
            </button>
          )}
        </div>

        {/* Sort */}
        <select
          value={sortKey}
          onChange={handleSortChange}
          className="sort-select"
        >
          {Object.entries(SORT_OPTIONS).map(([key, opt]) => (
            <option key={key} value={key}>{opt.label}</option>
          ))}
        </select>
      </div>

      {/* Song List */}
      <div className="song-list">
        {displayedSongs.map(song => {
          const isPlayed = playedSongs.has(song.song_id);
          return (
            <div
              key={song.song_id}
              className={`song-row ${isPlayed ? 'played' : ''}`}
              onClick={() => onTogglePlayed(song.song_id)}
            >
              <div className="played-indicator">
                {isPlayed ? '✓' : '○'}
              </div>
              <div className="song-info">
                <div className="song-title">{song.title}</div>
                <div className="song-artist">{song.artist}</div>
              </div>
            </div>
          );
        })}

        {displayedSongs.length === 0 && searchQuery && (
          <div className="no-results">
            No songs match "{searchQuery}"
          </div>
        )}

        {songs.length === 0 && (
          <div className="empty-state">
            Select a game to load songs
          </div>
        )}
      </div>
    </div>
  );
}
```

2. Create SongChecklist.css:

```css
.song-checklist {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #1a1a1a;
  border-radius: 12px;
  overflow: hidden;
}

/* Header */
.checklist-header {
  padding: 16px;
  border-bottom: 1px solid #333;
}

.stats {
  font-size: 18px;
}

.played-count {
  font-weight: bold;
  color: #1DB954;
  font-size: 24px;
}

.total-count {
  color: #888;
}

/* Controls */
.checklist-controls {
  padding: 12px 16px;
  display: flex;
  gap: 12px;
  border-bottom: 1px solid #333;
  background: #222;
}

.search-box {
  flex: 1;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 10px 36px 10px 12px;
  background: #333;
  border: 1px solid #444;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
}

.search-input:focus {
  outline: none;
  border-color: #1DB954;
}

.search-input::placeholder {
  color: #888;
}

.clear-search {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #888;
  font-size: 20px;
  cursor: pointer;
  padding: 4px 8px;
}

.clear-search:hover {
  color: #fff;
}

.sort-select {
  padding: 10px 12px;
  background: #333;
  border: 1px solid #444;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  min-width: 120px;
}

.sort-select:focus {
  outline: none;
  border-color: #1DB954;
}

/* Song List */
.song-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.song-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background 0.15s ease;
  border-bottom: 1px solid #252525;
}

.song-row:hover {
  background: #252525;
}

.song-row.played {
  opacity: 0.6;
}

.song-row.played .song-title {
  text-decoration: line-through;
  color: #888;
}

.played-indicator {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #555;
  border: 2px solid #444;
  border-radius: 50%;
  flex-shrink: 0;
}

.song-row.played .played-indicator {
  background: #1DB954;
  border-color: #1DB954;
  color: #fff;
}

.song-info {
  flex: 1;
  min-width: 0;
}

.song-title {
  font-size: 15px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.song-artist {
  font-size: 13px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 2px;
}

/* Empty States */
.no-results,
.empty-state {
  padding: 40px 20px;
  text-align: center;
  color: #666;
}
```
  </action>
  <verify>Component renders without errors</verify>
  <done>SongChecklist component with sort/search/mark created</done>
</task>

<task type="auto">
  <name>Task 4: Update App.js with new UI</name>
  <files>musicbingo_host/src/App.js, musicbingo_host/src/App.css</files>
  <action>
1. Update App.js to use the new components:

```jsx
import React from 'react';
import './App.css';
import { useGameState } from './hooks/useGameState';
import { SongChecklist } from './components/SongChecklist';

function App() {
  const {
    games,
    currentGame,
    songs,
    playedSongs,
    playedCount,
    totalCount,
    isLoading,
    error,
    loadGame,
    toggleSongPlayed,
  } = useGameState();

  const handleGameChange = (e) => {
    const filename = e.target.value;
    if (filename) {
      loadGame(filename);
    }
  };

  return (
    <div className="app">
      <header className="app-header">
        <h1>Music Bingo Host</h1>

        <div className="game-selector">
          <select
            onChange={handleGameChange}
            value={currentGame?.game_name || ''}
            disabled={isLoading}
          >
            <option value="">Select a game...</option>
            {games.map(game => (
              <option key={game} value={game}>{game}</option>
            ))}
          </select>
        </div>
      </header>

      {error && (
        <div className="error-banner">
          {error}
        </div>
      )}

      {isLoading && (
        <div className="loading">Loading...</div>
      )}

      <main className="app-main">
        <SongChecklist
          songs={songs}
          playedSongs={playedSongs}
          onTogglePlayed={toggleSongPlayed}
          playedCount={playedCount}
          totalCount={totalCount}
        />
      </main>

      <footer className="app-footer">
        <p>
          Play music in Spotify with shuffle on.
          Mark songs here as they play.
        </p>
      </footer>
    </div>
  );
}

export default App;
```

2. Update App.css:

```css
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: #121212;
  color: #fff;
  min-height: 100vh;
}

.app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  max-width: 600px;
  margin: 0 auto;
  padding: 16px;
}

/* Header */
.app-header {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-bottom: 16px;
}

.app-header h1 {
  font-size: 24px;
  font-weight: 600;
}

.game-selector select {
  width: 100%;
  padding: 12px;
  background: #222;
  border: 1px solid #333;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}

.game-selector select:focus {
  outline: none;
  border-color: #1DB954;
}

/* Error */
.error-banner {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid #ff6b6b;
  color: #ff6b6b;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: #888;
}

/* Main */
.app-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* Footer */
.app-footer {
  padding: 16px 0;
  text-align: center;
  color: #666;
  font-size: 14px;
}
```
  </action>
  <verify>npm start, app loads, game selector works, song list displays</verify>
  <done>Host app updated with checklist UI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Old Spotify/Apple Music code removed
- [ ] Game selector loads games from API
- [ ] Song list displays all songs
- [ ] Search filters songs in real-time
- [ ] Sort changes song order (title/artist, asc/desc)
- [ ] Tap on song marks it as played
- [ ] Played songs show checkmark and dimmed style
- [ ] Tap again to unmark
- [ ] Played count updates
- [ ] State polls from API every 2 seconds
</verification>

<success_criteria>
- Clean UI focused on song checklist (no player controls)
- Fast search to find songs when heard
- Sort by title or artist (A-Z, Z-A)
- Visual indication of played songs
- Syncs with backend for scanner consistency
- Responsive and touch-friendly
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-02-SUMMARY.md`
</output>
