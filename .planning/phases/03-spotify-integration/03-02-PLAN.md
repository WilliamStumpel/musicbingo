---
phase: 03-spotify-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - musicbingo_host/public/index.html
  - musicbingo_host/src/services/spotifyPlayer.js
  - musicbingo_host/src/hooks/useSpotifyPlayer.js
  - musicbingo_host/src/components/PlayerControls.jsx
  - musicbingo_host/src/App.js
autonomous: true
---

<objective>
Integrate Spotify Web Playback SDK to create a functional music player in the browser.

Purpose: Enable the host app to act as a Spotify Connect device, playing music directly in the browser with full playback controls.

Output: Working player with play/pause, seek, volume controls, and current track display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-spotify-integration/DISCOVERY.md
@.planning/phases/03-spotify-integration/03-01-SUMMARY.md
@musicbingo_host/src/services/spotifyAuth.js
@musicbingo_host/src/hooks/useSpotifyAuth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Spotify Player service and hook</name>
  <files>musicbingo_host/public/index.html, musicbingo_host/src/services/spotifyPlayer.js, musicbingo_host/src/hooks/useSpotifyPlayer.js</files>
  <action>
1. Add Spotify SDK script to public/index.html:
   ```html
   <script src="https://sdk.scdn.co/spotify-player.js"></script>
   ```

2. Create spotifyPlayer.js service:

   State (module-level):
   - player: null (Spotify.Player instance)
   - deviceId: null
   - isReady: false

   Functions:
   - initializePlayer(getToken) - Create Spotify.Player instance
     * name: 'Music Bingo Host'
     * getOAuthToken: callback that calls getToken() and passes to cb
     * volume: 0.5
     * Add event listeners for ready, not_ready, player_state_changed, errors
     * Call player.connect()
     * Return promise that resolves with deviceId when ready

   - disconnectPlayer() - Call player.disconnect(), reset state

   - playTrack(trackUri, positionMs = 0) - Use Web API to start playback:
     * PUT https://api.spotify.com/v1/me/player/play
     * Headers: Authorization: Bearer {token}
     * Body: { device_id, uris: [trackUri], position_ms: positionMs }
     * Need to get fresh token for API call

   - playTracks(trackUris, positionMs = 0) - Play array of tracks

   - pause() - player.pause()
   - resume() - player.resume()
   - togglePlay() - player.togglePlay()
   - seek(positionMs) - player.seek(positionMs)
   - setVolume(value) - player.setVolume(value) where value is 0-1
   - getVolume() - player.getVolume()
   - nextTrack() - player.nextTrack()
   - previousTrack() - player.previousTrack()
   - getCurrentState() - player.getCurrentState()
   - getDeviceId() - return deviceId

   - onStateChange(callback) - subscribe to state changes
   - offStateChange(callback) - unsubscribe

3. Create useSpotifyPlayer.js hook:

   State:
   - isReady: boolean
   - isPlaying: boolean
   - currentTrack: { name, artist, album, albumArt, duration, uri } | null
   - position: number (ms)
   - volume: number (0-1)
   - error: string | null

   Effects:
   - On mount (if authenticated): Initialize player
   - Subscribe to player_state_changed, update state
   - Update position every second when playing (setInterval)
   - On unmount: Disconnect player, cleanup interval

   Exposed:
   - All state
   - play(uri, positionMs), pause(), resume(), togglePlay()
   - seek(positionMs), setVolume(value)
   - nextTrack(), previousTrack()
   - deviceId
  </action>
  <verify>Import useSpotifyPlayer in App.js, log isReady and deviceId after login</verify>
  <done>Player initializes after login, deviceId is logged, no console errors</done>
</task>

<task type="auto">
  <name>Task 2: Create PlayerControls UI component</name>
  <files>musicbingo_host/src/components/PlayerControls.jsx, musicbingo_host/src/components/PlayerControls.css, musicbingo_host/src/App.js</files>
  <action>
1. Create PlayerControls.jsx component:

   Props: Receives all state and functions from useSpotifyPlayer

   Layout (vertical stack):
   - Current track display:
     * Album art (64x64 image)
     * Track name (bold)
     * Artist name (gray)
     * Show "No track playing" if currentTrack is null

   - Progress bar:
     * Clickable/draggable bar showing position/duration
     * Time display: current / total (format as m:ss)
     * onClick: Calculate position from click X, call seek()

   - Playback controls (horizontal row, centered):
     * Previous button (⏮ or SVG icon)
     * Play/Pause toggle button (▶/⏸)
     * Next button (⏭)

   - Volume control:
     * Speaker icon
     * Horizontal slider (input type="range" min=0 max=100)
     * onChange: setVolume(value/100)

   - Device status:
     * Show "Connected as: Music Bingo Host" when ready
     * Show "Connecting..." when not ready

2. Create PlayerControls.css:
   - Spotify-inspired dark theme (#121212 background, #1DB954 accent)
   - Responsive controls
   - Hover states for buttons
   - Smooth transitions

3. Update App.js:
   - When authenticated, show PlayerControls
   - Pass all player state and functions as props
   - Add a test button to play a sample track (hardcode a popular track URI for testing)

Test track URI for verification: spotify:track:4cOdK2wGLETKBW3PvgPWqT (Rick Astley - Never Gonna Give You Up)
  </action>
  <verify>Login, wait for "Connected", click play test track, see track info, use play/pause/seek/volume</verify>
  <done>Full playback controls work, track info displays, progress updates in real-time</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Spotify SDK loads without errors
- [ ] Player connects and shows device ID
- [ ] "Music Bingo Host" appears in Spotify Connect devices
- [ ] Test track plays through browser
- [ ] Play/pause toggles correctly
- [ ] Seek updates position
- [ ] Volume slider works
- [ ] Track info (name, artist, album art) displays correctly
- [ ] Progress bar updates during playback
</verification>

<success_criteria>
- Web Playback SDK integrated and functional
- Browser acts as Spotify Connect device
- All basic playback controls work (play, pause, seek, volume)
- Current track info displays with album art
- Real-time progress tracking
- Clean, Spotify-inspired UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-spotify-integration/03-02-SUMMARY.md`
</output>
