---
phase: 07-prize-winner-tracking
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - musicbingo_api/src/musicbingo_api/models.py
  - musicbingo_api/src/musicbingo_api/schemas.py
  - musicbingo_api/src/musicbingo_api/game_service.py
  - musicbingo_api/src/musicbingo_api/main.py
  - musicbingo_host/src/components/WinnerToast.jsx
  - musicbingo_host/src/components/WinnerToast.css
  - musicbingo_host/src/hooks/useGameState.js
  - musicbingo_host/src/pages/HostView.jsx
autonomous: true
---

<objective>
Implement winner detection system that checks all registered cards when songs are marked, plus prize configuration per game.

Purpose: Proactively detect winners so DJ knows when someone has bingo (private alert), and allow setting prize for display.
Output: Backend winner detection logic, card status API, prize configuration, host toast notifications.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-prize-winner-tracking/07-01-SUMMARY.md

@musicbingo_api/src/musicbingo_api/models.py
@musicbingo_api/src/musicbingo_api/game_service.py
@musicbingo_api/src/musicbingo_api/main.py
@musicbingo_host/src/hooks/useGameState.js
@musicbingo_host/src/pages/HostView.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prize field and winner detection to GameState</name>
  <files>musicbingo_api/src/musicbingo_api/models.py</files>
  <action>
Add to GameState dataclass:

1. `current_prize: Optional[str] = None` - Prize text for current game/round

2. `detected_winners: list[dict] = field(default_factory=list)` - List of detected winners, each dict contains:
   - card_id: UUID
   - card_number: int
   - player_name: str
   - pattern: PatternType
   - detected_at: datetime
   - song_id: UUID (the song that completed the win)

3. Add method `check_registered_cards_for_winners(self) -> list[dict]`:
   - Iterate through registered_cards
   - For each registered card, get the CardData from self.cards
   - Check if card is a winner using existing verify_card logic
   - Return list of NEW winners (not already in detected_winners)
   - Each winner dict includes: card_id, card_number, player_name, pattern, detected_at

4. Add method `get_card_statuses(self) -> list[dict]`:
   - For each registered card, return:
     - card_id, card_number, player_name
     - matches: int (how many of their songs have been played)
     - total_needed: int (how many needed for current pattern)
     - is_winner: bool
     - progress: str (e.g., "4/5" or "WINNER")
  </action>
  <verify>Python syntax check: `python -c "from musicbingo_api.models import GameState"`</verify>
  <done>GameState has prize field, detected_winners, and winner detection methods</done>
</task>

<task type="auto">
  <name>Task 2: Add card status and prize schemas</name>
  <files>musicbingo_api/src/musicbingo_api/schemas.py</files>
  <action>
Add schemas:

```python
class CardStatusInfo(BaseModel):
    """Status info for a registered card."""
    card_id: UUID
    card_number: int
    player_name: str
    matches: int
    total_needed: int
    is_winner: bool
    progress: str  # e.g., "4/5" or "WINNER"

class CardStatusesResponse(BaseModel):
    """Response with status of all registered cards."""
    game_id: UUID
    current_pattern: PatternType
    cards: list[CardStatusInfo]
    winners: list[CardStatusInfo]  # Just the winners for easy access

class DetectedWinner(BaseModel):
    """A detected winner."""
    card_id: UUID
    card_number: int
    player_name: str
    pattern: PatternType
    detected_at: datetime
    song_id: UUID

class SetPrizeRequest(BaseModel):
    """Request to set the prize for current game."""
    prize: str = Field(..., min_length=1, max_length=200)

class SetPrizeResponse(BaseModel):
    """Response after setting prize."""
    game_id: UUID
    prize: str
```

Also update GameStateResponse to include:
- `current_prize: Optional[str] = None`
- `detected_winners: list[DetectedWinner] = []`
  </action>
  <verify>Python syntax check: `python -c "from musicbingo_api.schemas import CardStatusInfo, SetPrizeRequest"`</verify>
  <done>Card status and prize schemas defined</done>
</task>

<task type="auto">
  <name>Task 3: Add winner detection and prize methods to GameService</name>
  <files>musicbingo_api/src/musicbingo_api/game_service.py</files>
  <action>
Add methods to GameService:

1. `check_for_new_winners(self, game_id: UUID, triggering_song_id: UUID) -> list[dict]`:
   - Get game or raise
   - Call game.check_registered_cards_for_winners()
   - For each new winner, add to game.detected_winners with song_id
   - Return list of newly detected winners

2. `get_card_statuses(self, game_id: UUID) -> dict`:
   - Get game or raise
   - Call game.get_card_statuses()
   - Return dict with game_id, current_pattern, cards list, winners list

3. `set_prize(self, game_id: UUID, prize: str) -> GameState`:
   - Get game or raise
   - Set game.current_prize = prize
   - Return game

4. Modify `toggle_song_played` to call `check_for_new_winners` when marking a song as played (played=True):
   - After adding song to played_songs
   - Call check_for_new_winners(game_id, song_uuid)
   - Store result in game state for polling

5. Modify `reset_round` to also clear:
   - detected_winners list
   - (keep current_prize - it persists across rounds)
  </action>
  <verify>Python syntax check: `python -c "from musicbingo_api.game_service import GameService"`</verify>
  <done>GameService has winner detection, card status, and prize methods</done>
</task>

<task type="auto">
  <name>Task 4: Add card status and prize API endpoints</name>
  <files>musicbingo_api/src/musicbingo_api/main.py</files>
  <action>
Add endpoints:

1. `GET /api/game/{game_id}/card-statuses`:
   - Returns CardStatusesResponse with all registered cards and their win progress
   - 404 if game not found

2. `POST /api/game/{game_id}/prize`:
   - Request body: SetPrizeRequest (prize text)
   - Calls service.set_prize()
   - Returns SetPrizeResponse
   - 404 if game not found

Update existing GameStateResponse returns to include current_prize and detected_winners fields.

Import new schemas at top of file.
  </action>
  <verify>Test endpoints: `curl http://localhost:8000/api/game/{id}/card-statuses`</verify>
  <done>Card status and prize endpoints functional</done>
</task>

<task type="auto">
  <name>Task 5: Add winner detection to host gameApi</name>
  <files>musicbingo_host/src/services/gameApi.js</files>
  <action>
Add functions:

```javascript
export async function getCardStatuses(gameId) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/card-statuses`);
  if (!response.ok) throw new Error('Failed to get card statuses');
  return response.json();
}

export async function setPrize(gameId, prize) {
  const response = await fetch(`${API_BASE}/api/game/${gameId}/prize`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prize }),
  });
  if (!response.ok) throw new Error('Failed to set prize');
  return response.json();
}
```
  </action>
  <verify>Functions exported correctly</verify>
  <done>gameApi has getCardStatuses and setPrize functions</done>
</task>

<task type="auto">
  <name>Task 6: Create WinnerToast component</name>
  <files>musicbingo_host/src/components/WinnerToast.jsx, musicbingo_host/src/components/WinnerToast.css</files>
  <action>
Create WinnerToast component for private DJ notifications:

WinnerToast.jsx:
- Props: winners (array of {card_number, player_name, pattern}), onDismiss
- Shows toast notification in top-right corner
- Each winner shown as: "BINGO! Card #42 - John (5-in-a-row)"
- Auto-dismiss after 10 seconds OR click to dismiss
- Stack multiple toasts if multiple winners detected
- Animate in (slide from right)

WinnerToast.css:
- Fixed position top-right
- Dark background with gold/yellow accent (celebration feel)
- White text, bold card number
- Slide-in animation from right
- Stack vertically with gap
- z-index high enough to be above other content
  </action>
  <verify>Component renders without errors</verify>
  <done>WinnerToast component created with animation and auto-dismiss</done>
</task>

<task type="auto">
  <name>Task 7: Integrate winner detection into useGameState</name>
  <files>musicbingo_host/src/hooks/useGameState.js</files>
  <action>
Add winner detection to useGameState hook:

1. Add state:
   - `detectedWinners: []` - Array of detected winners from API
   - `newWinners: []` - Newly detected winners to show in toast (not yet dismissed)
   - `currentPrize: null` - Current prize text

2. Update polling to check for new winners:
   - In poll function, compare state.detected_winners with previous
   - If new winners found, add to newWinners state (triggers toast)

3. Add `dismissWinner(cardId)` function:
   - Remove winner from newWinners array
   - (They stay in detectedWinners for the log)

4. Add `setPrize(prize)` function:
   - Call gameApi.setPrize(gameId, prize)
   - Update currentPrize state
   - Sync to localStorage for player view

5. Update resetRound to also clear:
   - detectedWinners
   - newWinners

Return new state and actions: detectedWinners, newWinners, currentPrize, dismissWinner, setPrize
  </action>
  <verify>Hook compiles without errors, new state available</verify>
  <done>useGameState tracks winners and prize, triggers toasts for new winners</done>
</task>

<task type="auto">
  <name>Task 8: Add WinnerToast to HostView</name>
  <files>musicbingo_host/src/pages/HostView.jsx</files>
  <action>
Integrate WinnerToast into HostView:

1. Import WinnerToast component
2. Destructure newWinners and dismissWinner from useGameState
3. Add WinnerToast component to render (outside main layout, fixed position):

```jsx
<WinnerToast
  winners={newWinners}
  onDismiss={dismissWinner}
/>
```

The toast will appear automatically when newWinners has items, and disappear when dismissed or auto-timeout.
  </action>
  <verify>Toast appears when winner detected during gameplay</verify>
  <done>HostView shows winner toasts when new winners detected</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Backend: Card statuses endpoint returns match progress for all registered cards
- [ ] Backend: Prize endpoint sets and returns prize
- [ ] Backend: Winners detected when songs marked
- [ ] Backend: GameStateResponse includes detected_winners and current_prize
- [ ] Host: Toast appears when new winner detected
- [ ] Host: Toast auto-dismisses or can be clicked to dismiss
- [ ] No TypeScript/Python errors
</verification>

<success_criteria>
- All tasks completed
- Winner detection runs when songs are marked
- Card status API shows progress toward winning
- Prize can be set via API
- Host sees toast notification for new winners (private)
</success_criteria>

<output>
After completion, create `.planning/phases/07-prize-winner-tracking/07-02-SUMMARY.md`
</output>
